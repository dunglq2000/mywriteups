

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TJCTF 2024 phần 3 &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/myfile.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'TJCTF-2024-part-3';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="TJCTF 2024 phần 2" href="TJCTF-2024-part-2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2021</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cryptoCTF-2021.html">Crypto CTF 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="googleCTF-2021.html">Google CTF 2021</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2022</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="isitdtu-2022.html">ISITDTU Quals 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="downunderCTF-2022.html">DownUnder CTF 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="sekaiCTF-2022.html">Sekai CTF 2022</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2023</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="diceCTF-2023.html">Dice CTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="googleCTF-2023.html">Google CTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="2023-18-12-backdoorCTF-2023.html">Backdoor CTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="utctf-2023.html">UTCTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="wolvCTF-2023.html">Wolv CTF 2023</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2024</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="0xL4ughCTF-2024.html">0xL4ugh CTF 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="TJCTF-2024-part-1.html">TJCTF 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="TJCTF-2024-part-2.html">TJCTF 2024 phần 2</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">TJCTF 2024 phần 3</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FTJCTF-2024-part-3.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/TJCTF-2024-part-3.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>TJCTF 2024 phần 3</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tetraethyllead">tetraethyllead</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-mo-hinh-feistel">a) Mô hình Feistel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-differential-attack">b) Differential attack</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-differential-vong-1">c) Differential vòng 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-differential-vong-2">d) Differential vòng 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#e-ham-z345">e) Hàm <code class="docutils literal notranslate"><span class="pre">z345</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f-giai">f) Giải</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="tjctf-2024-phan-3">
<h1>TJCTF 2024 phần 3<a class="headerlink" href="#tjctf-2024-phan-3" title="Permalink to this heading">#</a></h1>
<p>Mình dành hẳn một phần cho một bài vì bài này khá dài và phức tạp.</p>
<p>Đây cũng là bài viết đầu tiên của mình về một phương pháp tấn công cực kì phổ biến là differential attack (phá mã vi sai).</p>
<div class="section" id="tetraethyllead">
<h2>tetraethyllead<a class="headerlink" href="#tetraethyllead" title="Permalink to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># server.py</span>
<span class="c1">#!/usr/local/bin/python3 -u</span>

<span class="kn">import</span> <span class="nn">secrets</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="k">def</span> <span class="nf">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">%=</span> <span class="mi">32</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">i</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">%=</span> <span class="mi">32</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">i</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">get_sbox</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    
    <span class="n">Sbox</span> <span class="o">=</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">169</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">238</span><span class="p">]</span>

    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
        
    <span class="n">words</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">Sbox</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">Sbox</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sbox</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">Sbox</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">old</span>
        
    <span class="k">return</span> <span class="n">Sbox</span>

<span class="k">def</span> <span class="nf">getbit</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">setbit</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
    
<span class="k">def</span> <span class="nf">pbox</span><span class="p">(</span><span class="n">byte</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pos_subs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pos_in</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">|=</span> <span class="n">setbit</span><span class="p">(</span><span class="n">getbit</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">pos_in</span><span class="p">),</span> <span class="n">pos_subs</span><span class="p">[</span><span class="n">pos_in</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">pad1</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">r1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">byte</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">^=</span> <span class="n">out</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span>  <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pad1</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">r2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">byte</span><span class="p">])</span>
        
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">^=</span> <span class="n">out</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">zpad</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">i</span>

<span class="k">def</span> <span class="nf">zpad8</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">i</span>

<span class="k">def</span> <span class="nf">r345</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rnum</span><span class="p">):</span>
    <span class="n">word</span> <span class="o">^=</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">463</span> <span class="o">+</span> <span class="mi">439</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="o">-</span><span class="mi">144</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">63</span> <span class="o">+</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="n">rnum</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4124669716</span> <span class="o">+</span> <span class="n">word</span> <span class="o">*</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span>

    <span class="n">word</span> <span class="o">^=</span> <span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">word</span> <span class="o">^=</span> <span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>

    <span class="n">word</span> <span class="o">^=</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">463</span> <span class="o">+</span> <span class="mi">439</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="o">-</span><span class="mi">144</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">63</span> <span class="o">+</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="n">rnum</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">504</span> <span class="o">+</span> <span class="mi">418</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">-</span><span class="mi">499</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">511</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">98</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>

<span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">l</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>

    <span class="n">m_sbox_1</span> <span class="o">=</span> <span class="n">get_sbox</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
    <span class="n">m_sbox_2</span> <span class="o">=</span> <span class="n">get_sbox</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R0:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="c1">#round 1</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m_sbox_2</span><span class="p">)</span> 
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R1:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="c1">#round 2</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r1</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m_sbox_1</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 3</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R3:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="c1">#round 4</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R4:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 5</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span> <span class="o">^</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k1</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R5:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 6</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R6:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 7</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">^=</span> <span class="n">l</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R7:&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        
    
    <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">((</span><span class="n">l</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">r</span><span class="p">)</span>


<span class="c1"># I want you to be happy</span>

<span class="c1"># seecrit = b&quot;\x00&quot; + secrets.token_bytes(7)</span>
<span class="n">seecrit</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\xde\xad\xbe\xef\x13\x37\xff</span><span class="s2">&quot;</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;p: &quot;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">encrypt</span><span class="p">(</span><span class="n">zpad8</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">seecrit</span><span class="p">)))</span>

<span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;k: &quot;</span><span class="p">))</span>
<span class="k">if</span> <span class="p">(</span><span class="n">guess</span> <span class="o">==</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">seecrit</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flag.txt&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>Đây là một cipher sử dụng mô hình Feistel để mã hóa. Mô hình Feistel thường xuyên bị tấn công theo phương pháp differential, có thể kể đến như: DES, GOST, hay các phiên bản nhỏ hơn của chúng.</p>
<p>Do đó yêu cầu chống lại differential attack (cũng như người anh em khác của nó là linear attack) trở thành tiêu chuẩn để xây dựng block cipher hiện nay.</p>
<div class="section" id="a-mo-hinh-feistel">
<h3>a) Mô hình Feistel<a class="headerlink" href="#a-mo-hinh-feistel" title="Permalink to this heading">#</a></h3>
<p>Trong mô hình Feistel, mỗi block của plaintext sẽ được chia đôi thành hai nửa trái phải - <span class="math notranslate nohighlight">\(P = L_0 \Vert R_0\)</span>.</p>
<p>Ở bài này, plaintext có <span class="math notranslate nohighlight">\(8\)</span> bytes và key cũng có <span class="math notranslate nohighlight">\(8\)</span> bytes.</p>
<p>Trong mô hình Feistel chuẩn, ở mỗi vòng <span class="math notranslate nohighlight">\(i+1\)</span>, sẽ thực hiện biến đổi sau:</p>
<div class="math notranslate nohighlight">
\[L_{i+1} = R_i, \quad R_{i+1} = L_i \oplus F(R_i, K_{i+1})\]</div>
<p>Trong đó:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(K_{i+1}\)</span> là khóa ở vòng <span class="math notranslate nohighlight">\(i+1 với \)</span>i = 0, 1, \ldots$.</p></li>
<li><p><span class="math notranslate nohighlight">\(F\)</span> được gọi là round function. Hàm <span class="math notranslate nohighlight">\(F\)</span> phụ thuộc vào cipher là loại nào. Ví dụ thuật toán DES thì <span class="math notranslate nohighlight">\(F\)</span> là các phép biến đổi Expand, P-box và S-box. Hoặc đối với thuật toán GOST thì <span class="math notranslate nohighlight">\(F\)</span> gồm cộng modulo <span class="math notranslate nohighlight">\(2^{32}\)</span>, S-box và dịch <span class="math notranslate nohighlight">\(11\)</span> bit sang trái.</p></li>
</ul>
<p>Ở mô hình Feistel bên trên (cũng là mô hình chuẩn) thì hàm <span class="math notranslate nohighlight">\(F\)</span> cố định cho mỗi vòng. Tuy nhiên ở bài này thì round function ở mỗi vòng khác nhau. Cụ thể thì ở vòng một dùng S-box <code class="docutils literal notranslate"><span class="pre">r2</span></code>, ở vòng thứ hai là S-box <code class="docutils literal notranslate"><span class="pre">r1</span></code>, các vòng sau thì dùng hàm <code class="docutils literal notranslate"><span class="pre">r345</span></code>.</p>
<p>Mình có thể viết quá trình biến đổi như sau:</p>
<table class="table">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Vòng <span class="math notranslate nohighlight">\(1\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_1 = R_0\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_1 = L_0 \oplus r_2(R_0, S_2)\)</span></p></td>
</tr>
<tr class="row-even"><td><p>Vòng <span class="math notranslate nohighlight">\(2\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_2 = R_1\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_2 = L_1 \oplus r_1(R_1, S_1)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>Vòng <span class="math notranslate nohighlight">\(3\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_3 = R_2\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_3 = L_2 \oplus r_{345}(R_2, k_2, 3)\)</span></p></td>
</tr>
<tr class="row-even"><td><p>Vòng <span class="math notranslate nohighlight">\(4\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_4 = R_3\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_4 = L_3 \oplus r_{345}(R_3, k_2, 4)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>Vòng <span class="math notranslate nohighlight">\(5\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_5 = R_4\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_5 = L_4 \oplus r_{345}(R_4, k_1 \oplus k_2, 5)\)</span></p></td>
</tr>
<tr class="row-even"><td><p>Vòng <span class="math notranslate nohighlight">\(6\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_6 = R_5\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_6 = L_5 \oplus r_{345}(R_5, k_1, 6)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>Vòng <span class="math notranslate nohighlight">\(7\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(L_7 = L_6 \oplus r_{345}(R_6, k_2, 7)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(R_7 = R_6 \oplus L_7 = R_6 \oplus r_{345}(R_6, k_2, 7)\)</span></p></td>
</tr>
</tbody>
</table>
<p>Lưu ý rằng vòng cuối hơi khác một tí.</p>
</div>
<div class="section" id="b-differential-attack">
<h3>b) Differential attack<a class="headerlink" href="#b-differential-attack" title="Permalink to this heading">#</a></h3>
<p>Differential là gì???</p>
<p><strong>Định nghĩa.</strong> Xét hàm <span class="math notranslate nohighlight">\(S\)</span> từ <span class="math notranslate nohighlight">\(\mathbb{F}_2^n\)</span> tới <span class="math notranslate nohighlight">\(\mathbb{F}_2^m\)</span>. Với mỗi cặp vector <span class="math notranslate nohighlight">\(bm{a}, \bm{b} \in \mathbb{F}_2^n\)</span> thì ta nói <span class="math notranslate nohighlight">\(\bm{a} \oplus \bm{b}\)</span> là <strong>input differential</strong> và <span class="math notranslate nohighlight">\(S(\bm{a}) \oplus S(\bm{b})\)</span> là <strong>output differential</strong> ứng với hàm <span class="math notranslate nohighlight">\(S\)</span>.</p>
<p>Hàm <span class="math notranslate nohighlight">\(S\)</span> thường là các S-box trong block cipher. Các S-box thường không tuyến tính, nghĩa là ta không có <span class="math notranslate nohighlight">\(S(\bm{a} \oplus \bm{b}) = S(\bm{a}) \oplus S(\bm{b})\)</span>.</p>
<p>Differential dựa trên quan sát rằng khi <span class="math notranslate nohighlight">\(\bm{a} \oplus \bm{b}\)</span> cố định thì output differential <span class="math notranslate nohighlight">\(S(\bm{a}) \oplus S(\bm{b})\)</span> phân bố không đều. Giả sử mình có S-box như sau:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{|c|c|c|c|c|c|c|c|c||c|c|c|c|c|c|c|c|}
    \hline
    x &amp; 0 &amp; 1 &amp; 2 &amp; 3 &amp; 4 &amp; 5 &amp; 6 &amp; 7 &amp; 8 &amp; 9 &amp; 10 &amp; 11 &amp; 12 &amp; 13 &amp; 14 &amp; 15\\ \hline
    S(x) &amp; 3 &amp; 14 &amp; 1 &amp; 10 &amp; 4 &amp; 9 &amp; 5 &amp; 6 &amp; 8 &amp; 11 &amp; 15 &amp; 2 &amp; 13 &amp; 12 &amp; 0 &amp; 7 \\ \hline
\end{array}\end{split}\]</div>
<p>Nếu mình duyệt qua tất cả cặp <span class="math notranslate nohighlight">\(\bm{a}, \bm{b} \in \mathbb{F}_2^4\)</span> thì mình sẽ có quan sát sau:</p>
<ul class="simple">
<li><p>Nếu input vi sai là <span class="math notranslate nohighlight">\(0\)</span> thì output vi sai là <span class="math notranslate nohighlight">\(0\)</span> với xác suất <span class="math notranslate nohighlight">\(1\)</span>.</p></li>
<li><p>Nếu input vi sai là <span class="math notranslate nohighlight">\(1\)</span> thì output vi sai là <span class="math notranslate nohighlight">\(13\)</span> với xác suất <span class="math notranslate nohighlight">\(6 / 16\)</span>.</p></li>
<li><p>Nếu input vi sai là <span class="math notranslate nohighlight">\(4\)</span> thì output vi sai là <span class="math notranslate nohighlight">\(7\)</span> với xác suất <span class="math notranslate nohighlight">\(6 / 16\)</span>.</p></li>
<li><p>Nếu input vi sai là <span class="math notranslate nohighlight">\(8\)</span> thì output vi sai là <span class="math notranslate nohighlight">\(5\)</span> với xác suất <span class="math notranslate nohighlight">\(6 / 16\)</span>.</p></li>
<li><p>Nếu input vi sai là <span class="math notranslate nohighlight">\(15\)</span> thì output vi sai là <span class="math notranslate nohighlight">\(14\)</span> với xác suất <span class="math notranslate nohighlight">\(6 / 16\)</span>.</p></li>
</ul>
<p>Đây là những output differential với <strong>xác suất cao nhất</strong> ứng với mỗi input differential cố định <span class="math notranslate nohighlight">\(\bm{a} \oplus \bm{b}\)</span>.</p>
<p>Điều đó có nghĩa là cứ trung bình <span class="math notranslate nohighlight">\(16\)</span> cặp <span class="math notranslate nohighlight">\(\bm{a} \oplus \bm{b}\)</span> cho kết quả là <span class="math notranslate nohighlight">\(1\)</span> thì có <span class="math notranslate nohighlight">\(6\)</span> cặp cho output differential là <span class="math notranslate nohighlight">\(13\)</span>.</p>
<p>Tận dụng điều này, chúng ta sẽ giải bài tetraethyllead.</p>
<p>Giả sử <span class="math notranslate nohighlight">\((P, C)\)</span> và <span class="math notranslate nohighlight">\((P', C')\)</span> là hai cặp plaintext-ciphertext sao cho khi input differential <span class="math notranslate nohighlight">\(P \oplus P'\)</span> cố định thì xác suất xảy ra của output differential <span class="math notranslate nohighlight">\(C \oplus C'\)</span> cao nhất. Khi tìm được input và output differential như vậy, ta mã hóa nhiều plaintext khác nhau và khả năng (xác suất) xuất hiện ciphertext tương ứng thỏa mãn differential đó sẽ cao.</p>
<p>Giả sử <span class="math notranslate nohighlight">\(P = (L_0, R_0)\)</span> và <span class="math notranslate nohighlight">\(P' = (L'_0, R'_0)\)</span> là hai nửa trái phải tương ứng với <span class="math notranslate nohighlight">\(P\)</span> và <span class="math notranslate nohighlight">\(P'\)</span>.</p>
<p>Đặt <span class="math notranslate nohighlight">\(\Delta L_{in} = L_0 \oplus L'_0\)</span> và <span class="math notranslate nohighlight">\(\Delta R_{in} = R_0 \oplus R_0\)</span> là input differential trước khi mã hóa.</p>
<p>Đặt <span class="math notranslate nohighlight">\(\Delta L_{out} = L_7 \oplus L'_7\)</span> và <span class="math notranslate nohighlight">\(\Delta_{in} = R_7 \oplus R'_7\)</span> là output differential sau khi mã hóa.</p>
<p>Chúng ta sẽ đi qua từng hàm để xem với input-output differential nào thì khả năng xảy ra là cao nhất.</p>
</div>
<div class="section" id="c-differential-vong-1">
<h3>c) Differential vòng 1<a class="headerlink" href="#c-differential-vong-1" title="Permalink to this heading">#</a></h3>
<p>Sau vòng <span class="math notranslate nohighlight">\(1\)</span> ta có:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(L_1 = R_0\)</span> và <span class="math notranslate nohighlight">\(R_1 = L_0 \oplus r_2(R_0, S_2)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(L'_1 = R'_0\)</span> và <span class="math notranslate nohighlight">\(R'_1 = L'_0 \oplus r_2(R'_0, S_2)\)</span>.</p></li>
</ul>
<p>Khi đó differential ở vòng <span class="math notranslate nohighlight">\(1\)</span> là:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta L_1 = L_1 \oplus L'_1 = R_0 \oplus R'_0\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(\Delta R_1 = R_1 \oplus R'_1 = L_0 \oplus L'_0 \oplus r_2(R_0, S_2) \oplus r_2(R'_0, S_2)\)</span>.</p></li>
</ul>
<p>Như vậy <span class="math notranslate nohighlight">\(\Delta R_1\)</span> phụ thuộc vào vi sai của hàm <span class="math notranslate nohighlight">\(r_2\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">r2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">byte</span><span class="p">])</span>
        
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">^=</span> <span class="n">out</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]))</span>
</pre></div>
</div>
<p>Giả sử bốn bytes đầu vào của <span class="math notranslate nohighlight">\(r_2\)</span> là <span class="math notranslate nohighlight">\(a \Vert b \Vert c \Vert d\)</span>. Tiếp theo ta thay thế bốn bytes này bởi giá trị S-box của nó là <span class="math notranslate nohighlight">\(S_2(a) \Vert S_2(b) \Vert S_2(c) \Vert S_2(d)\)</span>. Vòng lặp thứ hai XOR chồng các bytes lên nhau để có kết quả:</p>
<div class="math notranslate nohighlight">
\[S_2(a) \oplus S_2(b) \oplus S_2(c) \oplus S_2(d) \Vert S_2(b) \oplus S_2(c) \oplus S_2(d) \Vert S_2(c) \oplus S_2(d) \Vert S_2(d)\]</div>
<p>Như vậy nếu <span class="math notranslate nohighlight">\(R_0 = a \Vert b \Vert c \Vert d\)</span> và <span class="math notranslate nohighlight">\(R'_0 = a' \Vert b' \Vert c' \Vert d'\)</span> thì:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    r_2(R_0, S_2) \oplus r_2(R_0', S_2) = &amp; S_2(a) \oplus S_2(b) \oplus S_2(c) \oplus S_2(d) \oplus S_2(a') \oplus S_2(b') \oplus S_2(c') \oplus S_2(d') \\ 
    \Vert &amp; S_2(b) \oplus S_2(c) \oplus S_2(d') \oplus S_2(b') \oplus S_2(c') \oplus S_2(d') \\ 
    \Vert &amp; S_2(c) \oplus S_2(d) \oplus S_2(c') \oplus S_2(d') \\ 
    \Vert &amp; S_2(d) \oplus S_2(d')
\end{align*}\end{split}\]</div>
<p>Dễ thấy rằng nếu chúng ta chọn <span class="math notranslate nohighlight">\(d = d'\)</span> thì byte cuối triệt tiêu.</p>
<p>Tiếp theo chọn <span class="math notranslate nohighlight">\(c = c'\)</span> thì byte kế cuối cũng triệt tiêu.</p>
<p>Tiếp theo chọn <span class="math notranslate nohighlight">\(b = b'\)</span> thì byte thứ ba (từ phải sang trái) cũng triệt tiêu.</p>
<p>Khi đó vi sai sẽ là <span class="math notranslate nohighlight">\(r_2(R_0, S_2) \oplus r_2(R_0', S_2) = S_2(a) \oplus S_2(a') \Vert 00 \Vert 00 \Vert 00\)</span>.</p>
<p>Bằng một cách <em>ảo ma</em> nào đó thì output differential <span class="math notranslate nohighlight">\(S_2(a) \oplus S_2(a') = 0x80\)</span> có xác suất xảy ra cao nhất khi input differential là <span class="math notranslate nohighlight">\(0x80\)</span>. Cái này writeup nói nhưng chúng ta cũng có thể kiểm tra phân bố vi sai của <span class="math notranslate nohighlight">\(r_2\)</span>.</p>
<p>Đi ngược lên trên thì <span class="math notranslate nohighlight">\(a \Vert b \Vert c \Vert d \oplus a' \Vert b' \Vert c' \Vert d' = 80 \Vert 00 \Vert 00 \Vert 00\)</span>. Đây chính là vi sai cho <span class="math notranslate nohighlight">\(R_0 \oplus R_0'\)</span>.</p>
<p>Như vậy <span class="math notranslate nohighlight">\(\Delta L_1 = 0x80000000\)</span> (với xác suất là <span class="math notranslate nohighlight">\(1\)</span>) và <span class="math notranslate nohighlight">\(\Delta R_1 = L_0 \oplus L_0' \oplus 0x80000000\)</span> (với xác suất cao).</p>
</div>
<div class="section" id="d-differential-vong-2">
<h3>d) Differential vòng 2<a class="headerlink" href="#d-differential-vong-2" title="Permalink to this heading">#</a></h3>
<p>Tương tự, đối với <span class="math notranslate nohighlight">\(r_1\)</span> chúng ta cũng dùng phương pháp tương tự.</p>
<p>Sau vòng <span class="math notranslate nohighlight">\(2\)</span> ta có:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(L_2 = R_1\)</span> và <span class="math notranslate nohighlight">\(R_2 = L_1 \oplus r_1(R_1, S_1)\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(L'_2 = R'_1\)</span> và <span class="math notranslate nohighlight">\(R'_2 = L'_1 \oplus r_1(R'_1, S_1)\)</span>.</p></li>
</ul>
<p>Khi đó differential ở vòng <span class="math notranslate nohighlight">\(2\)</span> là:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta L_2 = L_2 \oplus L'_2 = R_1 \oplus R'_1 = L_0 \oplus L_0' \oplus 0x80000000\)</span> (với xác suất cao).</p></li>
<li><p><span class="math notranslate nohighlight">\(\Delta R_2 = R_2 \oplus R'_2 = L_1 \oplus L'_1 \oplus r_1(R_1, S_1) \oplus r_1(R'_1, S_1) = 0x80000000 \oplus r_1(R_1, S_1) \oplus r_1(R'_1, S_1)\)</span>.</p></li>
</ul>
<p>Khi này, <span class="math notranslate nohighlight">\(R_1 \oplus R_1'\)</span> rất khó kiểm soát nên chúng ta sẽ khiến <span class="math notranslate nohighlight">\(R_1 = R_1'\)</span>. Khi đó <span class="math notranslate nohighlight">\(r_1(R_1, S_1) \oplus r_1(R_1', S_1) = 00\)</span> với xác suất bằng <span class="math notranslate nohighlight">\(1\)</span>.</p>
<p>Nếu <span class="math notranslate nohighlight">\(R_1 = R_1'\)</span> thì quay ngược lên trên, <span class="math notranslate nohighlight">\(\Delta R_1 = 00 = L_0 \oplus L_0' \oplus 0x80000000\)</span> nên <span class="math notranslate nohighlight">\(L_0 \oplus L_0' = 0x80000000\)</span>.</p>
<p>Như vậy mình đã tìm được input differential cho cả hàm mã hóa là <span class="math notranslate nohighlight">\(L_0 \oplus L_0' = 0x80000000\)</span> và <span class="math notranslate nohighlight">\(R_0 \oplus R_0' = 0x80000000\)</span>.</p>
<p>Lúc này, differential ở vòng <span class="math notranslate nohighlight">\(2\)</span> có xác suất xảy ra cao nhất là <span class="math notranslate nohighlight">\(L_2 \oplus L_2' = 0x00000000\)</span> và <span class="math notranslate nohighlight">\(R_2 \oplus R_2' = 0x80000000\)</span>.</p>
<p>Tiếp theo, mình cần biết output differential nào của toàn bộ hàm <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> sẽ có khả năng xảy ra nhất đối với input differential này.</p>
</div>
<div class="section" id="e-ham-z345">
<h3>e) Hàm <code class="docutils literal notranslate"><span class="pre">z345</span></code><a class="headerlink" href="#e-ham-z345" title="Permalink to this heading">#</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">r345</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rnum</span><span class="p">):</span>
    <span class="n">word</span> <span class="o">^=</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">463</span> <span class="o">+</span> <span class="mi">439</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="o">-</span><span class="mi">144</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">63</span> <span class="o">+</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="n">rnum</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4124669716</span> <span class="o">+</span> <span class="n">word</span> <span class="o">*</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span>

    <span class="n">word</span> <span class="o">^=</span> <span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">word</span> <span class="o">^=</span> <span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>

    <span class="n">word</span> <span class="o">^=</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">463</span> <span class="o">+</span> <span class="mi">439</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="o">-</span><span class="mi">144</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">63</span> <span class="o">+</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="n">rnum</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">504</span> <span class="o">+</span> <span class="mi">418</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">-</span><span class="mi">499</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">511</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">98</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</pre></div>
</div>
<p>Khi thay các giá trị <code class="docutils literal notranslate"><span class="pre">rnum</span></code> vào thì mình thấy có <span class="math notranslate nohighlight">\(3\)</span> vòng <code class="docutils literal notranslate"><span class="pre">rrot</span></code> và <code class="docutils literal notranslate"><span class="pre">lrot</span></code> ngược nhau (<code class="docutils literal notranslate"><span class="pre">rrot(word,</span> <span class="pre">17)</span></code> và <code class="docutils literal notranslate"><span class="pre">lrot(word,</span> <span class="pre">15)</span></code> trên <span class="math notranslate nohighlight">\(32\)</span> bit) nên ở những vòng này <code class="docutils literal notranslate"><span class="pre">rrot</span></code> và <code class="docutils literal notranslate"><span class="pre">lrot</span></code> sẽ triệt tiêu nhau do đa thức.</p>
<p>Tiếp theo, <code class="docutils literal notranslate"><span class="pre">word</span> <span class="pre">^=</span> <span class="pre">word</span> <span class="pre">&lt;&lt;</span> <span class="pre">5</span></code> sẽ không làm thay đổi differential <span class="math notranslate nohighlight">\(0x80\)</span>. Lấy ví dụ với <span class="math notranslate nohighlight">\(8\)</span> bit <span class="math notranslate nohighlight">\(\bar{a} = a_0 a_1 a_2 a_3 a_4 a_5 a_6 a_7\)</span> và <span class="math notranslate nohighlight">\(\bar{b} = b_0 b_1 b_2 b_3 b_4 b_5 b_6 b_7\)</span>. Giả sử <span class="math notranslate nohighlight">\(\bar{a} \oplus \bar{b} = 0x80\)</span> thì:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    \bar{a} \oplus (\bar{a} &lt;&lt; 5) \oplus \bar{b} \oplus (\bar{b} &lt;&lt; 5) = &amp; a_0 a_1 a_2 a_3 a_4 a_5 a_6 a_7 \oplus a_5 a_6 a_7 0 0 0 0 0 \\ \oplus &amp; b_0 b_1 b_2 b_3 b_4 b_5 b_6 b_7 \oplus b_5 b_6 b_7 00000 \\ = &amp; \underbrace{(a_0 a_1 a_2 a_3 a_4 a_5 a_6 a_7 \oplus b_0 b_1 b_2 b_3 b_4 b_5 b_6 b_7)}_{0x80} \\ \oplus &amp; \underbrace{(a_5 a_6 a_7 00000 \oplus b_5 b_6 b_7 00000)}_{0x00} = 0x80
\end{align*}\end{split}\]</div>
<p>Cuối cùng, phép nhân modulo <span class="math notranslate nohighlight">\(2^{32}\)</span> có <span class="math notranslate nohighlight">\(50%\)</span> duy trì differential <span class="math notranslate nohighlight">\(0x80000000\)</span> và do đó differential này vẫn có xác suất cao cho cả <code class="docutils literal notranslate"><span class="pre">z345</span></code>.</p>
</div>
<div class="section" id="f-giai">
<h3>f) Giải<a class="headerlink" href="#f-giai" title="Permalink to this heading">#</a></h3>
<p>Chiến thuật để giải bài này là:</p>
<ul class="simple">
<li><p>Gửi lên các cặp plaintext sao cho <span class="math notranslate nohighlight">\(\Delta L_{in} = 0x80000000\)</span> và <span class="math notranslate nohighlight">\(\Delta R_{in} = 0x80000000\)</span>.</p></li>
<li><p>Nhận các cặp ciphertext tương ứng thỏa mãn <span class="math notranslate nohighlight">\(\Delta L_{out} \oplus R_{out} = 0x80000000\)</span>.</p></li>
</ul>
<p>Các cặp plaintext, ciphertext như trên sẽ giúp ta khôi phục lại khóa.</p>
<p><strong>Note.</strong> Để thuận tiện thì mình sẽ cố định khóa trong <code class="docutils literal notranslate"><span class="pre">server.py</span></code> và chỉ cần tìm ra khóa là xong. Ở trong giải thì sau khi request đủ <span class="math notranslate nohighlight">\(1024\)</span> lần encrypt server cũng không đặt timeout nên chúng ta có thể để script chạy bao lâu tùy ý.</p>
<p>File <code class="docutils literal notranslate"><span class="pre">solve.py</span></code> sau đây tương tác với <code class="docutils literal notranslate"><span class="pre">server.py</span></code> để lấy về các cặp plaintext, ciphertext thỏa mãn điều kiện trên.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="k">def</span> <span class="nf">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">%=</span> <span class="mi">32</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">i</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">%=</span> <span class="mi">32</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">word</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">i</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">get_sbox</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    
    <span class="n">Sbox</span> <span class="o">=</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">169</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">238</span><span class="p">]</span>

    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;S-box&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hex</span><span class="p">())</span>
        
    <span class="n">words</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">Sbox</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">Sbox</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sbox</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">Sbox</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">old</span>

    <span class="nb">print</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">Sbox</span>

<span class="k">def</span> <span class="nf">getbit</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">setbit</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
    
<span class="k">def</span> <span class="nf">pbox</span><span class="p">(</span><span class="n">byte</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pos_subs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pos_in</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">|=</span> <span class="n">setbit</span><span class="p">(</span><span class="n">getbit</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">pos_in</span><span class="p">),</span> <span class="n">pos_subs</span><span class="p">[</span><span class="n">pos_in</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">pad1</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">r1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">byte</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">([</span><span class="nb">hex</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">^=</span> <span class="n">out</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">([</span><span class="nb">hex</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>

    <span class="k">return</span>  <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pad1</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">r2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">byte</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">byte</span><span class="p">])</span>
        
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">^=</span> <span class="n">out</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">zpad</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">i</span>

<span class="k">def</span> <span class="nf">zpad8</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">i</span>

<span class="k">def</span> <span class="nf">r345</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rnum</span><span class="p">):</span>
    <span class="n">word</span> <span class="o">^=</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">463</span> <span class="o">+</span> <span class="mi">439</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="o">-</span><span class="mi">144</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">63</span> <span class="o">+</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="n">rnum</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">word</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4124669716</span> <span class="o">+</span> <span class="n">word</span> <span class="o">*</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">3</span>

    <span class="n">word</span> <span class="o">^=</span> <span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>
    <span class="n">word</span> <span class="o">^=</span> <span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span>

    <span class="n">word</span> <span class="o">^=</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">463</span> <span class="o">+</span> <span class="mi">439</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="o">-</span><span class="mi">144</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="mi">63</span> <span class="o">+</span> <span class="o">-</span><span class="mi">43</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="n">rnum</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="o">-</span><span class="mi">504</span> <span class="o">+</span> <span class="mi">418</span> <span class="o">*</span> <span class="n">rnum</span> <span class="o">-</span><span class="mi">499</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">511</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">98</span> <span class="o">*</span> <span class="n">rnum</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>

<span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">l</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>

    <span class="n">m_sbox_1</span> <span class="o">=</span> <span class="n">get_sbox</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
    <span class="n">m_sbox_2</span> <span class="o">=</span> <span class="n">get_sbox</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>

    <span class="n">LS</span><span class="p">,</span> <span class="n">RS</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">l</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">i</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R0:&quot;, l,  r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R0:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="c1">#round 1</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m_sbox_2</span><span class="p">)</span> 
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R1:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R1:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="c1">#round 2</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r1</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m_sbox_1</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R2:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R2:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 3</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R3:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R3:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="c1">#round 4</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R4:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R4:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 5</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">long_to_bytes</span><span class="p">(</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span> <span class="o">^</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">k1</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R5:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R5:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 6</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R6:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R6:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1">#round 7</span>
    <span class="n">l</span> <span class="o">^=</span> <span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">^=</span> <span class="n">l</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="c1"># print(&quot;R7:&quot;,l, r)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R7:</span><span class="se">\t</span><span class="si">{</span><span class="n">l</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">,</span><span class="se">\t</span><span class="si">{</span><span class="n">r</span><span class="si">:</span><span class="s2">08x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">LS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">long_to_bytes</span><span class="p">((</span><span class="n">l</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">r</span><span class="p">),</span> <span class="n">LS</span><span class="p">,</span> <span class="n">RS</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">process</span><span class="p">,</span> <span class="n">context</span>

<span class="c1"># context.log_level = &#39;Debug&#39;</span>

<span class="n">pr</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span> <span class="s2">&quot;server.py&quot;</span><span class="p">])</span>

<span class="n">pts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ct0s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ct1s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1024</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;p: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">p_</span> <span class="o">=</span> <span class="mh">0x8000000080000000</span> <span class="o">^</span> <span class="n">p</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;p: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">c_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
    <span class="n">lout</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">c_</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">rout</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">c_</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lout</span> <span class="o">^</span> <span class="n">rout</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80000000</span><span class="p">:</span>
        <span class="n">pts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">ct0s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ct1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ct0s</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ct1s</span><span class="p">)</span>
</pre></div>
</div>
<p>Sau đó sử dụng thư viện SHA256 từ project <a class="reference external" href="https://github.com/System-Glitch/SHA256">này</a> (gồm file <code class="docutils literal notranslate"><span class="pre">SHA256.h</span></code> và <code class="docutils literal notranslate"><span class="pre">SHA256.cpp</span></code>).</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SHA256.h&quot;</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">bytes_to_u32</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">u32_to_bytes</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">u64_to_bytes</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">in</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">56</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">rrot</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">%=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">word</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">get_sbox</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">Sbox</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="mi">87</span><span class="p">,</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="mi">91</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">93</span><span class="p">,</span><span class="w"> </span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mi">94</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="mi">74</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">78</span><span class="p">,</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">115</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">118</span><span class="p">,</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="mi">122</span><span class="p">,</span><span class="w"> </span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="mi">124</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">126</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">103</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">107</span><span class="p">,</span><span class="w"> </span><span class="mi">106</span><span class="p">,</span><span class="w"> </span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">145</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="p">,</span><span class="w"> </span><span class="mi">147</span><span class="p">,</span><span class="w"> </span><span class="mi">146</span><span class="p">,</span><span class="w"> </span><span class="mi">149</span><span class="p">,</span><span class="w"> </span><span class="mi">148</span><span class="p">,</span><span class="w"> </span><span class="mi">151</span><span class="p">,</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="mi">153</span><span class="p">,</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="w"> </span><span class="mi">155</span><span class="p">,</span><span class="w"> </span><span class="mi">154</span><span class="p">,</span><span class="w"> </span><span class="mi">157</span><span class="p">,</span><span class="w"> </span><span class="mi">156</span><span class="p">,</span><span class="w"> </span><span class="mi">159</span><span class="p">,</span><span class="w"> </span><span class="mi">158</span><span class="p">,</span><span class="w"> </span><span class="mi">129</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">131</span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">,</span><span class="w"> </span><span class="mi">133</span><span class="p">,</span><span class="w"> </span><span class="mi">132</span><span class="p">,</span><span class="w"> </span><span class="mi">135</span><span class="p">,</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span><span class="w"> </span><span class="mi">136</span><span class="p">,</span><span class="w"> </span><span class="mi">139</span><span class="p">,</span><span class="w"> </span><span class="mi">138</span><span class="p">,</span><span class="w"> </span><span class="mi">141</span><span class="p">,</span><span class="w"> </span><span class="mi">140</span><span class="p">,</span><span class="w"> </span><span class="mi">143</span><span class="p">,</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w"> </span><span class="mi">177</span><span class="p">,</span><span class="w"> </span><span class="mi">176</span><span class="p">,</span><span class="w"> </span><span class="mi">179</span><span class="p">,</span><span class="w"> </span><span class="mi">178</span><span class="p">,</span><span class="w"> </span><span class="mi">181</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">183</span><span class="p">,</span><span class="w"> </span><span class="mi">182</span><span class="p">,</span><span class="w"> </span><span class="mi">185</span><span class="p">,</span><span class="w"> </span><span class="mi">184</span><span class="p">,</span><span class="w"> </span><span class="mi">187</span><span class="p">,</span><span class="w"> </span><span class="mi">186</span><span class="p">,</span><span class="w"> </span><span class="mi">189</span><span class="p">,</span><span class="w"> </span><span class="mi">188</span><span class="p">,</span><span class="w"> </span><span class="mi">191</span><span class="p">,</span><span class="w"> </span><span class="mi">190</span><span class="p">,</span><span class="w"> </span><span class="mi">161</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">163</span><span class="p">,</span><span class="w"> </span><span class="mi">162</span><span class="p">,</span><span class="w"> </span><span class="mi">165</span><span class="p">,</span><span class="w"> </span><span class="mi">164</span><span class="p">,</span><span class="w"> </span><span class="mi">167</span><span class="p">,</span><span class="w"> </span><span class="mi">166</span><span class="p">,</span><span class="w"> </span><span class="mi">169</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">171</span><span class="p">,</span><span class="w"> </span><span class="mi">170</span><span class="p">,</span><span class="w"> </span><span class="mi">173</span><span class="p">,</span><span class="w"> </span><span class="mi">172</span><span class="p">,</span><span class="w"> </span><span class="mi">175</span><span class="p">,</span><span class="w"> </span><span class="mi">174</span><span class="p">,</span><span class="w"> </span><span class="mi">209</span><span class="p">,</span><span class="w"> </span><span class="mi">208</span><span class="p">,</span><span class="w"> </span><span class="mi">211</span><span class="p">,</span><span class="w"> </span><span class="mi">210</span><span class="p">,</span><span class="w"> </span><span class="mi">213</span><span class="p">,</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="mi">214</span><span class="p">,</span><span class="w"> </span><span class="mi">217</span><span class="p">,</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w"> </span><span class="mi">219</span><span class="p">,</span><span class="w"> </span><span class="mi">218</span><span class="p">,</span><span class="w"> </span><span class="mi">221</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="mi">223</span><span class="p">,</span><span class="w"> </span><span class="mi">222</span><span class="p">,</span><span class="w"> </span><span class="mi">193</span><span class="p">,</span><span class="w"> </span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">195</span><span class="p">,</span><span class="w"> </span><span class="mi">194</span><span class="p">,</span><span class="w"> </span><span class="mi">197</span><span class="p">,</span><span class="w"> </span><span class="mi">196</span><span class="p">,</span><span class="w"> </span><span class="mi">199</span><span class="p">,</span><span class="w"> </span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">201</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">203</span><span class="p">,</span><span class="w"> </span><span class="mi">202</span><span class="p">,</span><span class="w"> </span><span class="mi">205</span><span class="p">,</span><span class="w"> </span><span class="mi">204</span><span class="p">,</span><span class="w"> </span><span class="mi">207</span><span class="p">,</span><span class="w"> </span><span class="mi">206</span><span class="p">,</span><span class="w"> </span><span class="mi">241</span><span class="p">,</span><span class="w"> </span><span class="mi">240</span><span class="p">,</span><span class="w"> </span><span class="mi">243</span><span class="p">,</span><span class="w"> </span><span class="mi">242</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">244</span><span class="p">,</span><span class="w"> </span><span class="mi">247</span><span class="p">,</span><span class="w"> </span><span class="mi">246</span><span class="p">,</span><span class="w"> </span><span class="mi">249</span><span class="p">,</span><span class="w"> </span><span class="mi">248</span><span class="p">,</span><span class="w"> </span><span class="mi">251</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">253</span><span class="p">,</span><span class="w"> </span><span class="mi">252</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">254</span><span class="p">,</span><span class="w"> </span><span class="mi">225</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">227</span><span class="p">,</span><span class="w"> </span><span class="mi">226</span><span class="p">,</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="mi">228</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">,</span><span class="w"> </span><span class="mi">230</span><span class="p">,</span><span class="w"> </span><span class="mi">233</span><span class="p">,</span><span class="w"> </span><span class="mi">232</span><span class="p">,</span><span class="w"> </span><span class="mi">235</span><span class="p">,</span><span class="w"> </span><span class="mi">234</span><span class="p">,</span><span class="w"> </span><span class="mi">237</span><span class="p">,</span><span class="w"> </span><span class="mi">236</span><span class="p">,</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="mi">238</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="n">SHA256</span><span class="w"> </span><span class="n">sha256</span><span class="p">;</span>
<span class="w">    </span><span class="n">sha256</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sha256</span><span class="p">.</span><span class="n">digest</span><span class="p">();</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">SHA256</span><span class="w"> </span><span class="n">sha</span><span class="p">;</span>
<span class="w">        </span><span class="n">sha</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sha</span><span class="p">.</span><span class="n">digest</span><span class="p">();</span>
<span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">32</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sbox</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
<span class="w">        </span><span class="n">Sbox</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sbox</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
<span class="w">        </span><span class="n">Sbox</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">Sbox</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">lrot</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">i</span><span class="w"> </span><span class="o">%=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">word</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">word</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">)))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">r1</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">box</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">u32_to_bytes</span><span class="p">(</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytes_to_u32</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">r2</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">box</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">u32_to_bytes</span><span class="p">(</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">box</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bytes_to_u32</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">r345</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">rnum</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">-463</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">439</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-144</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-43</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="p">);</span>

<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">4124669716</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">k</span><span class="p">);</span>
<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">word</span><span class="p">;</span>

<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="w">    </span><span class="n">word</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">-463</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">439</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-144</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">lrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-43</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="p">);</span>


<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">rrot</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="mi">-504</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">418</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="mi">-499</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-511</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">98</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rnum</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="n">sbox1</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">sbox2</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>

<span class="kt">uint64_t</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>

<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">t1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="w">    </span><span class="n">u32_to_bytes</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">);</span>

<span class="w">    </span><span class="n">get_sbox</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">sbox1</span><span class="p">);</span>

<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Round 1</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">sbox2</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Round 2</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r1</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">sbox1</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Round 3</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="p">,</span><span class="n">r</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Round 4</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">k2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Round 5</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">k2</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Round 6</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Round 7</span>
<span class="w">    </span><span class="n">l</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">k2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span>
<span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="n">l</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">l</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">test_function</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sbox</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">166</span><span class="p">,</span><span class="w"> </span><span class="mi">167</span><span class="p">,</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">171</span><span class="p">,</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="mi">124</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">,</span><span class="w"> </span><span class="mi">130</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">233</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">,</span><span class="w"> </span><span class="mi">53</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">245</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">91</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">,</span><span class="w"> </span><span class="mi">248</span><span class="p">,</span><span class="w"> </span><span class="mi">223</span><span class="p">,</span><span class="w"> </span><span class="mi">253</span><span class="p">,</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">52</span><span class="p">,</span><span class="w"> </span><span class="mi">221</span><span class="p">,</span><span class="w"> </span><span class="mi">54</span><span class="p">,</span><span class="w"> </span><span class="mi">72</span><span class="p">,</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="mi">96</span><span class="p">,</span><span class="w"> </span><span class="mi">103</span><span class="p">,</span><span class="w"> </span><span class="mi">135</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="mi">63</span><span class="p">,</span><span class="w"> </span><span class="mi">74</span><span class="p">,</span><span class="w"> </span><span class="mi">161</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="mi">39</span><span class="p">,</span><span class="w"> </span><span class="mi">163</span><span class="p">,</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">43</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">222</span><span class="p">,</span><span class="w"> </span><span class="mi">211</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">168</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="mi">83</span><span class="p">,</span><span class="w"> </span><span class="mi">177</span><span class="p">,</span><span class="w"> </span><span class="mi">229</span><span class="p">,</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="mi">121</span><span class="p">,</span><span class="w"> </span><span class="mi">86</span><span class="p">,</span><span class="w"> </span><span class="mi">228</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">31</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">93</span><span class="p">,</span><span class="w"> </span><span class="mi">92</span><span class="p">,</span><span class="w"> </span><span class="mi">139</span><span class="p">,</span><span class="w"> </span><span class="mi">94</span><span class="p">,</span><span class="w"> </span><span class="mi">76</span><span class="p">,</span><span class="w"> </span><span class="mi">152</span><span class="p">,</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">66</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">156</span><span class="p">,</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="mi">107</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">90</span><span class="p">,</span><span class="w"> </span><span class="mi">65</span><span class="p">,</span><span class="w"> </span><span class="mi">102</span><span class="p">,</span><span class="w"> </span><span class="mi">247</span><span class="p">,</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">244</span><span class="p">,</span><span class="w"> </span><span class="mi">119</span><span class="p">,</span><span class="w"> </span><span class="mi">118</span><span class="p">,</span><span class="w"> </span><span class="mi">87</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="mi">122</span><span class="p">,</span><span class="w"> </span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="mi">179</span><span class="p">,</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w"> </span><span class="mi">48</span><span class="p">,</span><span class="w"> </span><span class="mi">82</span><span class="p">,</span><span class="w"> </span><span class="mi">59</span><span class="p">,</span><span class="w"> </span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">201</span><span class="p">,</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="mi">178</span><span class="p">,</span><span class="w"> </span><span class="mi">112</span><span class="p">,</span><span class="w"> </span><span class="mi">106</span><span class="p">,</span><span class="w"> </span><span class="mi">78</span><span class="p">,</span><span class="w"> </span><span class="mi">242</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">144</span><span class="p">,</span><span class="w"> </span><span class="mi">147</span><span class="p">,</span><span class="w"> </span><span class="mi">146</span><span class="p">,</span><span class="w"> </span><span class="mi">149</span><span class="p">,</span><span class="w"> </span><span class="mi">148</span><span class="p">,</span><span class="w"> </span><span class="mi">249</span><span class="p">,</span><span class="w"> </span><span class="mi">105</span><span class="p">,</span><span class="w"> </span><span class="mi">153</span><span class="p">,</span><span class="w"> </span><span class="mi">172</span><span class="p">,</span><span class="w"> </span><span class="mi">155</span><span class="p">,</span><span class="w"> </span><span class="mi">154</span><span class="p">,</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w"> </span><span class="mi">131</span><span class="p">,</span><span class="w"> </span><span class="mi">234</span><span class="p">,</span><span class="w"> </span><span class="mi">143</span><span class="p">,</span><span class="w"> </span><span class="mi">129</span><span class="p">,</span><span class="w"> </span><span class="mi">225</span><span class="p">,</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w"> </span><span class="mi">35</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">49</span><span class="p">,</span><span class="w"> </span><span class="mi">210</span><span class="p">,</span><span class="w"> </span><span class="mi">136</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">191</span><span class="p">,</span><span class="w"> </span><span class="mi">141</span><span class="p">,</span><span class="w"> </span><span class="mi">140</span><span class="p">,</span><span class="w"> </span><span class="mi">158</span><span class="p">,</span><span class="w"> </span><span class="mi">142</span><span class="p">,</span><span class="w"> </span><span class="mi">199</span><span class="p">,</span><span class="w"> </span><span class="mi">176</span><span class="p">,</span><span class="w"> </span><span class="mi">104</span><span class="p">,</span><span class="w"> </span><span class="mi">209</span><span class="p">,</span><span class="w"> </span><span class="mi">170</span><span class="p">,</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span><span class="w"> </span><span class="mi">183</span><span class="p">,</span><span class="w"> </span><span class="mi">182</span><span class="p">,</span><span class="w"> </span><span class="mi">185</span><span class="p">,</span><span class="w"> </span><span class="mi">184</span><span class="p">,</span><span class="w"> </span><span class="mi">238</span><span class="p">,</span><span class="w"> </span><span class="mi">186</span><span class="p">,</span><span class="w"> </span><span class="mi">189</span><span class="p">,</span><span class="w"> </span><span class="mi">188</span><span class="p">,</span><span class="w"> </span><span class="mi">126</span><span class="p">,</span><span class="w"> </span><span class="mi">230</span><span class="p">,</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">181</span><span class="p">,</span><span class="w"> </span><span class="mi">195</span><span class="p">,</span><span class="w"> </span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="mi">162</span><span class="p">,</span><span class="w"> </span><span class="mi">169</span><span class="p">,</span><span class="w"> </span><span class="mi">81</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">165</span><span class="p">,</span><span class="w"> </span><span class="mi">173</span><span class="p">,</span><span class="w"> </span><span class="mi">190</span><span class="p">,</span><span class="w"> </span><span class="mi">175</span><span class="p">,</span><span class="w"> </span><span class="mi">174</span><span class="p">,</span><span class="w"> </span><span class="mi">164</span><span class="p">,</span><span class="w"> </span><span class="mi">208</span><span class="p">,</span><span class="w"> </span><span class="mi">213</span><span class="p">,</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="mi">252</span><span class="p">,</span><span class="w"> </span><span class="mi">193</span><span class="p">,</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="mi">214</span><span class="p">,</span><span class="w"> </span><span class="mi">194</span><span class="p">,</span><span class="w"> </span><span class="mi">216</span><span class="p">,</span><span class="w"> </span><span class="mi">219</span><span class="p">,</span><span class="w"> </span><span class="mi">89</span><span class="p">,</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">218</span><span class="p">,</span><span class="w"> </span><span class="mi">115</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">157</span><span class="p">,</span><span class="w"> </span><span class="mi">192</span><span class="p">,</span><span class="w"> </span><span class="mi">204</span><span class="p">,</span><span class="w"> </span><span class="mi">44</span><span class="p">,</span><span class="w"> </span><span class="mi">197</span><span class="p">,</span><span class="w"> </span><span class="mi">196</span><span class="p">,</span><span class="w"> </span><span class="mi">227</span><span class="p">,</span><span class="w"> </span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="mi">203</span><span class="p">,</span><span class="w"> </span><span class="mi">202</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">23</span><span class="p">,</span><span class="w"> </span><span class="mi">207</span><span class="p">,</span><span class="w"> </span><span class="mi">206</span><span class="p">,</span><span class="w"> </span><span class="mi">241</span><span class="p">,</span><span class="w"> </span><span class="mi">240</span><span class="p">,</span><span class="w"> </span><span class="mi">243</span><span class="p">,</span><span class="w"> </span><span class="mi">145</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">75</span><span class="p">,</span><span class="w"> </span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">187</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">133</span><span class="p">,</span><span class="w"> </span><span class="mi">251</span><span class="p">,</span><span class="w"> </span><span class="mi">250</span><span class="p">,</span><span class="w"> </span><span class="mi">151</span><span class="p">,</span><span class="w"> </span><span class="mi">246</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w"> </span><span class="mi">254</span><span class="p">,</span><span class="w"> </span><span class="mi">217</span><span class="p">,</span><span class="w"> </span><span class="mi">98</span><span class="p">,</span><span class="w"> </span><span class="mi">224</span><span class="p">,</span><span class="w"> </span><span class="mi">226</span><span class="p">,</span><span class="w"> </span><span class="mi">61</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">,</span><span class="w"> </span><span class="mi">138</span><span class="p">,</span><span class="w"> </span><span class="mi">132</span><span class="p">,</span><span class="w"> </span><span class="mi">232</span><span class="p">,</span><span class="w"> </span><span class="mi">235</span><span class="p">,</span><span class="w"> </span><span class="mi">159</span><span class="p">,</span><span class="w"> </span><span class="mi">237</span><span class="p">,</span><span class="w"> </span><span class="mi">236</span><span class="p">,</span><span class="w"> </span><span class="mi">239</span><span class="p">,</span><span class="w"> </span><span class="mi">205</span><span class="w"> </span><span class="p">};</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r1</span><span class="p">(</span><span class="mi">211416476</span><span class="p">,</span><span class="w"> </span><span class="n">sbox</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">210016026</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r2</span><span class="p">(</span><span class="mi">1111418300</span><span class="p">,</span><span class="w"> </span><span class="n">sbox</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2596923053</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rrot</span><span class="p">(</span><span class="mi">2386637329</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2425123337</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lrot</span><span class="p">(</span><span class="mi">171861653</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3436355911</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">r345</span><span class="p">(</span><span class="mi">2332062217</span><span class="p">,</span><span class="w"> </span><span class="mh">0xdeadbeef</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3992978025</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="nf">check_k2</span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ct0</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ct1</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">L7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">R7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">R6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R7</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">L7</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">L6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R7</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">R6</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span>

<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">L7_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct1</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">R7_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct1</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xffffffff</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">R6_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R7_</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">L7_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">L6_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R7_</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">r345</span><span class="p">(</span><span class="n">R6_</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">L6</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">L6_</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x80000000</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bruteforce_k2</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">pts</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">2194090266659289430ULL</span><span class="p">,</span><span class="w"> </span><span class="mi">15801510715588955136ULL</span><span class="p">,</span><span class="w"> </span><span class="mi">195752496155878917ULL</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ct0s</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">5313144679078469543ULL</span><span class="p">,</span><span class="w"> </span><span class="mi">1721352893315118722ULL</span><span class="p">,</span><span class="w"> </span><span class="mi">6831354680889557863ULL</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">ct1s</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">14587251420890060969ULL</span><span class="p">,</span><span class="w"> </span><span class="mi">17919522859960426701ULL</span><span class="p">,</span><span class="w"> </span><span class="mi">5659069971483530659ULL</span><span class="w"> </span><span class="p">};</span>


<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">key2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span>
<span class="w">    </span><span class="cp">#pragma omp for</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x100000000</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_k2</span><span class="p">(</span><span class="n">ct0s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ct1s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">k</span><span class="p">))</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_k2</span><span class="p">(</span><span class="n">ct0s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">ct1s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">k</span><span class="p">))</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_k2</span><span class="p">(</span><span class="n">ct0s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">ct1s</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">k</span><span class="p">))</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">key2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">key2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Đầu tiên chúng ta sẽ khôi phục <code class="docutils literal notranslate"><span class="pre">k2</span></code> đi ngược từ ciphertex lên. Chúng ta nhận các khóa thỏa mãn <span class="math notranslate nohighlight">\(\Delta L_6 \oplus \Delta R_6 = 0x80000000\)</span> (vòng <span class="math notranslate nohighlight">\(6\)</span>). Để tìm <code class="docutils literal notranslate"><span class="pre">k2</span></code> thì hàm <code class="docutils literal notranslate"><span class="pre">main</span></code> sẽ là:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="p">{</span><span class="w">    </span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">key2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bruteforce_k2</span><span class="p">();</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">key2</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">hex</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">key2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sau đó với mỗi <code class="docutils literal notranslate"><span class="pre">k2</span></code> chúng ta bruteforce các <code class="docutils literal notranslate"><span class="pre">k1</span></code> và kiểm tra <code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">=</span> <span class="pre">k1</span> <span class="pre">||</span> <span class="pre">k2</span></code> nào sẽ encrypt đúng. Ở đây do mình đã cố định khóa ở <code class="docutils literal notranslate"><span class="pre">server.py</span></code> nên mình biết <code class="docutils literal notranslate"><span class="pre">k2</span></code> nào là đúng để tiết kiệm thời gian viết lại writeup. Sau đó thì chỉ cần bruteforce <code class="docutils literal notranslate"><span class="pre">k1</span></code> thôi.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">k2</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0xef</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="mh">0x37</span><span class="p">,</span><span class="w"> </span><span class="mh">0xff</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">get_sbox</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span><span class="w"> </span><span class="n">sbox2</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2194090266659289430ULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5313144679078469543ULL</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#pragma omp for</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0xffffff</span><span class="p">;</span><span class="w"> </span><span class="n">k1</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">k1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0xef1337ff</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">encrypt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Found key: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">hex</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Cám ơn các bạn đã đọc writeup dài lê thê của mình :)))</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="TJCTF-2024-part-2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">TJCTF 2024 phần 2</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tetraethyllead">tetraethyllead</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-mo-hinh-feistel">a) Mô hình Feistel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-differential-attack">b) Differential attack</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-differential-vong-1">c) Differential vòng 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#d-differential-vong-2">d) Differential vòng 2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#e-ham-z345">e) Hàm <code class="docutils literal notranslate"><span class="pre">z345</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#f-giai">f) Giải</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>