
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Google CTF 2023 &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="_static/myfile.css?v=564be945" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'googleCTF-2023';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Backdoor CTF 2023" href="2023-18-12-backdoorCTF-2023.html" />
    <link rel="prev" title="Dice CTF 2023" href="diceCTF-2023.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2021</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="cryptoCTF-2021.html">Crypto CTF 2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="googleCTF-2021.html">Google CTF 2021</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2022</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="isitdtu-2022.html">ISITDTU Quals 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="downunderCTF-2022.html">DownUnder CTF 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="sekaiCTF-2022.html">Sekai CTF 2022</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2023</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="diceCTF-2023.html">Dice CTF 2023</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Google CTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="2023-18-12-backdoorCTF-2023.html">Backdoor CTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="utctf-2023.html">UTCTF 2023</a></li>
<li class="toctree-l1"><a class="reference internal" href="wolvCTF-2023.html">Wolv CTF 2023</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">CTF 2024</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="0xL4ughCTF-2024.html">0xL4ugh CTF 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="TJCTF-2024-part-1.html">TJCTF 2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="TJCTF-2024-part-2.html">TJCTF 2024 phần 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="TJCTF-2024-part-3.html">TJCTF 2024 phần 3</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FgoogleCTF-2023.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/googleCTF-2023.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Google CTF 2023</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#least-common-genominator">LEAST COMMON GENOMINATOR?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cursved">Cursved</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mhk2">MHK2</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tao-private-key">1. Tạo private key</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tao-public-key">2. Tạo public key</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ma-hoa">3. Mã hóa</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#khoi-phuc-private-key">4. Khôi phục private key</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-khoi-phuc-modulo">a. Khôi phục modulo</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#b-khoi-phuc-e">b. Khôi phục e</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#c-code-giai">c. Code giải</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mytls">MYTLS</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#primes">PRIMES</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="google-ctf-2023">
<h1>Google CTF 2023<a class="headerlink" href="#google-ctf-2023" title="Link to this heading">#</a></h1>
<section id="least-common-genominator">
<h2>LEAST COMMON GENOMINATOR?<a class="headerlink" href="#least-common-genominator" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">secret</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">isPrime</span>

<span class="k">class</span> <span class="nc">LCG</span><span class="p">:</span>
    <span class="n">lcg_m</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">m</span>
    <span class="n">lcg_c</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">c</span>
    <span class="n">lcg_n</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">n</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lcg_s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">lcg_s</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcg_m</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcg_c</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcg_n</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="k">assert</span> <span class="mi">4096</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">it</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">it</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="mi">4096</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">bits</span> <span class="o">==</span> <span class="mi">512</span>

    <span class="c1"># Find prime value of specified bits a specified amount of times</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="mi">211286818345627549183608678726370412218029639873054513839005340650674982169404937862395980568550063504804783328450267566224937880641772833325018028629959635</span>
    <span class="n">lcg</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">primes_arr</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">dump</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">items</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dump_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;dump.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="n">primes_n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">it</span><span class="p">):</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">prime_candidate</span> <span class="o">=</span> <span class="n">lcg</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dump</span><span class="p">:</span>
                    <span class="n">dump_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prime_candidate</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">items</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">items</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                        <span class="n">dump</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">dump_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">prime_candidate</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">prime_candidate</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">bits</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">primes_n</span> <span class="o">*=</span> <span class="n">prime_candidate</span>
                    <span class="n">primes_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prime_candidate</span><span class="p">)</span>
                    <span class="k">break</span>
        
        <span class="c1"># Check bit length</span>
        <span class="k">if</span> <span class="n">primes_n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bit length&quot;</span><span class="p">,</span> <span class="n">primes_n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">())</span>
            <span class="n">primes_arr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">primes_n</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># Create public key &#39;n&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">primes_arr</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">*=</span> <span class="n">j</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Public Key: &quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] size: &quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">(),</span> <span class="s2">&quot;bits&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate totient &#39;Phi(n)&#39;</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">primes_arr</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">*=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate private key &#39;d&#39;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>

    <span class="c1"># Generate Flag</span>
    <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;CTF{&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">flag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
    <span class="n">enc_flag</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">enc_flag</span> <span class="o">&lt;</span> <span class="n">n</span>

    <span class="c1"># Encrypt Flag</span>
    <span class="n">_enc</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">enc_flag</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="s2">&quot;flag.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">flag_file</span><span class="p">:</span>
        <span class="n">flag_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_enc</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">(),</span> <span class="s2">&quot;little&quot;</span><span class="p">))</span>

    <span class="c1"># Export RSA Key</span>
    <span class="n">rsa</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">construct</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">e</span><span class="p">))</span>
    <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="s2">&quot;public.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pub_file</span><span class="p">:</span>
        <span class="n">pub_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rsa</span><span class="o">.</span><span class="n">exportKey</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</pre></div>
</div>
<p>Bài này sinh ra <span class="math notranslate nohighlight">\(8\)</span> số nguyên tố để mã hóa. Từ một trạng thái seed ban đầu <span class="math notranslate nohighlight">\(s\)</span>, số tiếp theo được sinh ra bởi số trước bởi công thức <span class="math notranslate nohighlight">\(s_{i+1} = (m s_i + c) \bmod{n}\)</span>.</p>
<p>Chúng ta chỉ biết seed ban đầu, không biết <span class="math notranslate nohighlight">\(m\)</span>, <span class="math notranslate nohighlight">\(c\)</span> hay <span class="math notranslate nohighlight">\(n\)</span>. Đề cho chúng ta dãy <span class="math notranslate nohighlight">\(6\)</span> số đầu tạo bởi chuỗi trên, giả sử là <span class="math notranslate nohighlight">\(s_0\)</span>, <span class="math notranslate nohighlight">\(s_1\)</span>, <span class="math notranslate nohighlight">\(s_2\)</span>, …</p>
<p>Mình thấy rằng <span class="math notranslate nohighlight">\(s_1 = (m s_0 + c) \bmod n\)</span>, <span class="math notranslate nohighlight">\(s_2 = (m s_1 + c) \bmod n\)</span> và <span class="math notranslate nohighlight">\(s_3 = (m s_2 + c) \bmod n\)</span>.</p>
<p>Trừ vế theo vế mình có <span class="math notranslate nohighlight">\(s_2 - s_1 = m (s_1 - s_0) \bmod n\)</span> và <span class="math notranslate nohighlight">\(s_3 - s_2 = m (s_2 - s_1) \bmod n\)</span>.</p>
<p>Suy ra <span class="math notranslate nohighlight">\(n \vert (s_2 - s_1) - m (s_1 - s_0)\)</span> và <span class="math notranslate nohighlight">\(n \vert (s_3 - s_2) - m (s_2 - s_1)\)</span>. Như vậy nhân chéo lên để khử <span class="math notranslate nohighlight">\(m\)</span> mình thu được <span class="math notranslate nohighlight">\(n \vert (s_2 - s_1)^2 - m(s_1 - s_0) (s_2 - s_1)\)</span> và <span class="math notranslate nohighlight">\(n \vert (s_3 - s_2) (s_1 - s_0) - m (s_2 - s_1) (s_1 - s_0)\)</span>. Hay</p>
<div class="math notranslate nohighlight">
\[n \vert (s_2 - s_1)^2 - (s_3 - s_2)(s_1 - s_0)\]</div>
<p>Tương tự như vậy với các cặp khác, dùng gcd mình sẽ tìm ra được <span class="math notranslate nohighlight">\(n\)</span>.</p>
<p>Khi đã có <span class="math notranslate nohighlight">\(n\)</span>, nhớ lại rằng <span class="math notranslate nohighlight">\(s_2 - s_1 = m (s_1 - s_0) \bmod n\)</span> sẽ suy ra được <span class="math notranslate nohighlight">\(m\)</span>. Cuối cùng do <span class="math notranslate nohighlight">\(s_1 = (m s_0 + c) \bmod n\)</span> nên sẽ tìm được <span class="math notranslate nohighlight">\(c\)</span>.</p>
<p>Có đủ <span class="math notranslate nohighlight">\(n\)</span>, <span class="math notranslate nohighlight">\(m\)</span> và <span class="math notranslate nohighlight">\(c\)</span> mình chạy hàm như đề bài là sẽ tìm được các số nguyên tố từ đó decrypt ra được kết quả.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">s0</span> <span class="o">=</span> <span class="mi">2166771675595184069339107365908377157701164485820981409993925279512199123418374034275465590004848135946671454084220731645099286746251308323653144363063385</span>
<span class="n">s1</span> <span class="o">=</span> <span class="mi">6729272950467625456298454678219613090467254824679318993052294587570153424935267364971827277137521929202783621553421958533761123653824135472378133765236115</span>
<span class="n">s2</span> <span class="o">=</span> <span class="mi">2230396903302352921484704122705539403201050490164649102182798059926343096511158288867301614648471516723052092761312105117735046752506523136197227936190287</span>
<span class="n">s3</span> <span class="o">=</span> <span class="mi">4578847787736143756850823407168519112175260092601476810539830792656568747136604250146858111418705054138266193348169239751046779010474924367072989895377792</span>
<span class="n">s4</span> <span class="o">=</span> <span class="mi">7578332979479086546637469036948482551151240099803812235949997147892871097982293017256475189504447955147399405791875395450814297264039908361472603256921612</span>
<span class="n">s5</span> <span class="o">=</span> <span class="mi">2550420443270381003007873520763042837493244197616666667768397146110589301602119884836605418664463550865399026934848289084292975494312467018767881691302197</span>
<span class="n">s_</span> <span class="o">=</span> <span class="mi">211286818345627549183608678726370412218029639873054513839005340650674982169404937862395980568550063504804783328450267566224937880641772833325018028629959635</span>

<span class="k">def</span> <span class="nf">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span>

<span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">s2</span> <span class="o">-</span> <span class="n">s1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">s1</span> <span class="o">-</span> <span class="n">s0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">s3</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">s2</span> <span class="o">-</span> <span class="n">s1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">s3</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">s1</span> <span class="o">-</span> <span class="n">s0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">s4</span> <span class="o">-</span> <span class="n">s3</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">s3</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">s2</span> <span class="o">-</span> <span class="n">s1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">s4</span> <span class="o">-</span> <span class="n">s3</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">gcd</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span>
<span class="n">m</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">s1</span><span class="o">-</span><span class="n">s2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">s2</span><span class="o">-</span><span class="n">s3</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">s0</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span>


<span class="k">class</span> <span class="nc">LCG</span><span class="p">:</span>
    <span class="n">lcg_m</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">lcg_c</span> <span class="o">=</span> <span class="n">c</span>
    <span class="n">lcg_n</span> <span class="o">=</span> <span class="n">n</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lcg_s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">lcg_s</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcg_m</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcg_c</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcg_n</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
    
<span class="n">primes_arr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">primes_n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">lcg</span> <span class="o">=</span> <span class="n">LCG</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">isPrime</span><span class="p">,</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>
<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">prime_candidate</span> <span class="o">=</span> <span class="n">lcg</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isPrime</span><span class="p">(</span><span class="n">prime_candidate</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">prime_candidate</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">512</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">primes_n</span> <span class="o">*=</span> <span class="n">prime_candidate</span>
                <span class="n">primes_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prime_candidate</span><span class="p">)</span>
                <span class="k">break</span>
    
    <span class="k">if</span> <span class="n">primes_n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">:</span>
        <span class="n">primes_arr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">primes_n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>

<span class="nb">print</span><span class="p">(</span><span class="n">primes_arr</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">primes_arr</span><span class="p">:</span>
    <span class="n">n</span> <span class="o">*=</span> <span class="n">j</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] Public Key: &quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[+] size: &quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">(),</span> <span class="s2">&quot;bits&quot;</span><span class="p">)</span>

<span class="c1"># Calculate totient &#39;Phi(n)&#39;</span>
<span class="n">phi</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">primes_arr</span><span class="p">:</span>
    <span class="n">phi</span> <span class="o">*=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Calculate private key &#39;d&#39;</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mi">65537</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
<span class="n">rsa</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;public.pem&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">rsa</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="n">n</span>
<span class="k">assert</span> <span class="n">rsa</span><span class="o">.</span><span class="n">e</span> <span class="o">==</span> <span class="mi">65537</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;flag.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s2">&quot;little&quot;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<span class="c1"># b&#39;CTF{C0nGr@tz_RiV35t_5h4MiR_nD_Ad13MaN_W0ulD_b_h@pPy}&#39;</span>
</pre></div>
</div>
</section>
<section id="cursved">
<h2>Cursved<a class="headerlink" href="#cursved" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2023 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">urandom</span>

<span class="k">def</span> <span class="nf">bytes_to_hexstr</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
  <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{0:02X}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">bytes_to_int</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">bytes_to_hexstr</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">random_int</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">bytes_to_int</span><span class="p">(</span><span class="n">urandom</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">sha256_as_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sha256</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_type</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">False</span>
  <span class="k">return</span> <span class="kc">True</span>

<span class="k">class</span> <span class="nc">Curve</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">D</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Curve(0x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">, 0x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">)&quot;</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">p</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">D</span>
  <span class="k">def</span> <span class="fm">__matmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">check_type</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="o">*</span><span class="n">other</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Point</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">Curve</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">C</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(0x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">, 0x</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">:</span><span class="s2">X</span><span class="si">}</span><span class="s2">)&quot;</span>
  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span>
  <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span>
    <span class="k">return</span> <span class="n">Point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="o">*</span><span class="n">x1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">D</span><span class="o">*</span><span class="n">y0</span><span class="o">*</span><span class="n">y1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="o">*</span><span class="n">y1</span> <span class="o">+</span> <span class="n">x1</span><span class="o">*</span><span class="n">y0</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
  <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">check_type</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span> <span class="p">(</span><span class="nb">int</span><span class="p">,)))</span>
    <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">@</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span>
    <span class="k">while</span> <span class="n">n</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">+</span> <span class="n">Q</span>
      <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">+</span> <span class="n">Q</span>
      <span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">P</span>
  <span class="k">def</span> <span class="nf">to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">p</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Pub</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P</span>
  <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">check_type</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="p">(</span><span class="n">Point</span><span class="p">,</span> <span class="nb">int</span><span class="p">)))</span>
    <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">sig</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">sha256_as_int</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">n</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">==</span> <span class="n">R</span> <span class="o">+</span> <span class="n">e</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">P</span>

<span class="k">class</span> <span class="nc">Priv</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="n">G</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">G</span>
  <span class="k">def</span> <span class="nf">get_pub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Pub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">random_int</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">n</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">sha256_as_int</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">()</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">n</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Problem</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pub</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pub</span> <span class="o">=</span> <span class="n">pub</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span>
  <span class="k">def</span> <span class="nf">parse_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
      <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">C</span> <span class="o">@</span> <span class="p">(</span><span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="k">return</span> <span class="kc">None</span>
  <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonce</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nonce</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">FLAG</span><span class="p">,</span> <span class="n">PRIVATE_KEY</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="n">C</span> <span class="o">=</span> <span class="n">Curve</span><span class="p">(</span><span class="mh">0x34096DC6CE88B7D7CB09DE1FEC1EDF9B448D4BE9E341A9F6DC696EF4E4E213B3</span><span class="p">,</span>
            <span class="mh">0x3</span><span class="p">,</span>
            <span class="mh">0x34096DC6CE88B7D7CB09DE1FEC1EDF9B448D4BE9E341A9F6DC696EF4E4E213B2</span><span class="p">)</span>
  <span class="n">G</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
  <span class="n">priv</span> <span class="o">=</span> <span class="n">Priv</span><span class="p">(</span><span class="n">PRIVATE_KEY</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
  <span class="n">pub</span> <span class="o">=</span> <span class="n">priv</span><span class="o">.</span><span class="n">get_pub</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pub = </span><span class="si">{</span><span class="n">pub</span><span class="o">.</span><span class="n">P</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">prob</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">pub</span><span class="p">)</span>
  <span class="n">nonce</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nonce = </span><span class="si">{</span><span class="n">bytes_to_hexstr</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;sig = &quot;</span><span class="p">)</span>
  <span class="n">sig</span> <span class="o">=</span> <span class="n">prob</span><span class="o">.</span><span class="n">parse_response</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prob</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">sig</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">FLAG</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please try again!&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Bài này định nghĩa một đường cong (có lẽ vậy) là tập hợp các điểm thỏa phương trình <span class="math notranslate nohighlight">\(x^2 = D y^2 + 1 \bmod p\)</span> với <span class="math notranslate nohighlight">\(D = 3\)</span> và <span class="math notranslate nohighlight">\(p\)</span> là số nguyên tố cho trước.</p>
<p>Phép cộng hai điểm <span class="math notranslate nohighlight">\((x_1, y_1)\)</span> và <span class="math notranslate nohighlight">\((x_2, y_2)\)</span> được định nghĩa là điểm <span class="math notranslate nohighlight">\((x_1 x_2 + D y_1 y_2, x_1 y_2 + x_2 y_1)\)</span> (tất cả trong modulo <span class="math notranslate nohighlight">\(p\)</span>).</p>
<p>Đề bài cho chúng ta biết điểm generator là <span class="math notranslate nohighlight">\(G = (2, 1)\)</span>, public key là một điểm không đổi trong tất cả lần chạy (điểm <span class="math notranslate nohighlight">\(P\)</span>). Mình gọi <span class="math notranslate nohighlight">\(k\)</span> là private key, là một số trong modulo <span class="math notranslate nohighlight">\(n = p-1\)</span> sao cho <span class="math notranslate nohighlight">\(P = k G\)</span>.</p>
<p>Hướng tấn công của bài này là xây dựng một homomorphism từ nhóm các điểm trên lên <span class="math notranslate nohighlight">\(\mathrm{GF}(p)\)</span> và giải discrete logarithm trên <span class="math notranslate nohighlight">\(\mathrm{GF}(p)\)</span>. Mình xét ánh xạ</p>
<div class="math notranslate nohighlight">
\[\varphi: \mathbb{F}_p \times \mathbb{F}_p \to \mathbb{F}_p, \quad (x, y) \to x + yW\]</div>
<p>Ở đây <span class="math notranslate nohighlight">\(W\)</span> là một số nào đó thuộc <span class="math notranslate nohighlight">\(\mathrm{GF}(p)\)</span>. Mình muốn ánh xạ này là homomorphism thì tương đương với điều kiện</p>
<div class="math notranslate nohighlight">
\[\varphi(x_1, y_1) \cdot \varphi(x_2, y_2) = \varphi(x_1 x_2 + D y_1 y_2, x_1 y_2 + x_2 y_1)\]</div>
<p>Tương đương với</p>
<div class="math notranslate nohighlight">
\[(x_1 + y_1 W) \cdot (x_2 + y_2 W) = (x_1 x_2 + D y_1 y_2) + (x_1 y_2 + x_2 y_1) W\]</div>
<p>Khai triển và thu gọn mình có được <span class="math notranslate nohighlight">\(W^2 = D\)</span>. Như vậy <span class="math notranslate nohighlight">\(W = \sqrt{3} \bmod p\)</span>.</p>
<p>Và đúng là <span class="math notranslate nohighlight">\(D\)</span> là số chính phương modulo <span class="math notranslate nohighlight">\(p\)</span> thật, quá tốt :))))</p>
<p>Như vậy mình sẽ chuyển việc tính toán discrete logarithm <span class="math notranslate nohighlight">\(P = k G\)</span> trên tập hợp các điểm trên thành việc tính toán discrete logarithm ứng với phương trình</p>
<div class="math notranslate nohighlight">
\[(x_G + y_G W)^k = (x_P + y_P W) \bmod p\]</div>
<p>Tới đây thì khá bế tắc vì <span class="math notranslate nohighlight">\(p-1\)</span> có các thừa số rất lớn. Mình đi “hỏi thăm” 1 vòng thì biết có tool open source rất mạnh để tính việc này là <a class="reference external" href="https://github.com/cado-nfs/cado-nfs">cado-nfs</a>.</p>
<p>Đặt <span class="math notranslate nohighlight">\(g = x_G + y_G W \bmod p\)</span> và <span class="math notranslate nohighlight">\(h = x_P + y_P W \bmod p\)</span>. Lúc giải mình thấy một điều lạ lùng là mình không dùng tool trên tính dlog modulo 2 được, nên mình chỉ tính dlog của <span class="math notranslate nohighlight">\(g\)</span> và <span class="math notranslate nohighlight">\(h\)</span> trên modulo <span class="math notranslate nohighlight">\((p-1)/2\)</span>. Cado-nfs sẽ trả về base, mình gọi là <span class="math notranslate nohighlight">\(b\)</span>, và dlog của <span class="math notranslate nohighlight">\(g\)</span> và <span class="math notranslate nohighlight">\(h\)</span> lần lượt là <span class="math notranslate nohighlight">\(t_1\)</span> và <span class="math notranslate nohighlight">\(t_2\)</span>.</p>
<p>Do <span class="math notranslate nohighlight">\(g = b^{t_1}\)</span>, <span class="math notranslate nohighlight">\(h = b^{t_2}\)</span>, <span class="math notranslate nohighlight">\(h = g^k\)</span> nên <span class="math notranslate nohighlight">\(b^{t_2} = b^{t_1 k}\)</span> (tất cả modulo <span class="math notranslate nohighlight">\(p\)</span>). Suy ra <span class="math notranslate nohighlight">\(t_2 = t_1 k \bmod \dfrac{p-1}{2}\)</span>, từ đó mình tìm được <span class="math notranslate nohighlight">\(k\)</span> và <span class="math notranslate nohighlight">\(k\)</span> này thỏa mãn <span class="math notranslate nohighlight">\(P = k G\)</span>.</p>
<p>Như vậy mình đã khôi phục lại private key và sẵn sàng ký bất cứ <code class="docutils literal notranslate"><span class="pre">nonce</span></code> nào gửi tới.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">process</span>

<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;Debug&#39;</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">Curve</span><span class="p">(</span><span class="mh">0x34096DC6CE88B7D7CB09DE1FEC1EDF9B448D4BE9E341A9F6DC696EF4E4E213B3</span><span class="p">,</span>
        <span class="mh">0x3</span><span class="p">,</span>
        <span class="mh">0x34096DC6CE88B7D7CB09DE1FEC1EDF9B448D4BE9E341A9F6DC696EF4E4E213B2</span><span class="p">)</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">C</span> <span class="o">@</span> <span class="p">(</span><span class="mh">0x2FE4D1B7BA0F64D6E5BD5E4E8D55E898FF13B76974646D97BFDCD9DC688C0E2F</span><span class="p">,</span> <span class="mh">0x8C33E2FC2957EFF24DD1CD5382169C3BFAAC2E75A900D322A8C84D3C641A27E</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">597042838662739992479017662198571932571177156379622917145185173378909836425</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">G</span> <span class="o">==</span> <span class="n">P</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&quot;cursved.2023.ctfcompetition.com&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<span class="c1">#r = process([&quot;python3&quot;, &quot;chal.py&quot;])</span>
<span class="n">priv</span> <span class="o">=</span> <span class="n">Priv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">pub</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="n">nonce</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">priv</span><span class="o">.</span><span class="n">get_pub</span><span class="p">()</span><span class="o">.</span><span class="n">P</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">priv</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">nonce</span><span class="p">))</span>
<span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">sig</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;sig = &quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># b&#39;CTF{pe11_conics_are_not_quite_e11iptic_curves}\n&#39;</span>
</pre></div>
</div>
</section>
<section id="mhk2">
<h2>MHK2<a class="headerlink" href="#mhk2" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">secrets</span>

<span class="n">random</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span>

<span class="n">MSG</span> <span class="o">=</span> <span class="s2">&quot;CTF{????}&quot;</span>


<span class="k">class</span> <span class="nc">PrivateKey</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">keytup</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">()):</span>
        <span class="k">if</span> <span class="n">keytup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e2</span> <span class="o">=</span> <span class="n">keytup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_sequence</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_pos_ints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_prime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">):</span> <span class="k">break</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_sequence</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_pos_ints</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_prime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">):</span> <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2</span>

    <span class="k">def</span> <span class="nf">_gen_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_gen_pos_ints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">export_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;s1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">s1</span><span class="p">,</span> <span class="s2">&quot;s2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span>
                <span class="s2">&quot;p1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">p2</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e1</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e2</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">PublicKey</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span> <span class="n">PrivateKey</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">private_key</span><span class="o">.</span><span class="n">e1</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">private_key</span><span class="o">.</span><span class="n">p1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">private_key</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">private_key</span><span class="o">.</span><span class="n">e2</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">private_key</span><span class="o">.</span><span class="n">p2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">private_key</span><span class="o">.</span><span class="n">s2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">private_key</span><span class="o">.</span><span class="n">s1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b2</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">private_key</span><span class="o">.</span><span class="n">s2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">private_key</span><span class="o">.</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">b2</span>

    <span class="k">def</span> <span class="nf">public_key_export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;a1&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">MHK2</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">private_key</span><span class="p">:</span> <span class="n">PrivateKey</span> <span class="o">=</span> <span class="n">PrivateKey</span><span class="p">,</span>
        <span class="n">public_key</span><span class="p">:</span> <span class="n">PublicKey</span> <span class="o">=</span> <span class="n">PublicKey</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">public_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_random_bin_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ciphertext</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msg_int</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;big&quot;</span><span class="p">))</span><span class="si">:</span><span class="s1">b</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msg_int</span><span class="p">:</span>
            <span class="n">ciphertext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encrypt_bit</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ciphertext</span>

    <span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">):</span>
        <span class="n">plaintext_bin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ciphertext</span><span class="p">:</span>
            <span class="n">plaintext_bin</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decrypt_bit</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">split_bin</span> <span class="o">=</span> <span class="p">[</span><span class="n">plaintext_bin</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plaintext_bin</span><span class="p">),</span> <span class="mi">8</span><span class="p">)]</span>

        <span class="n">plaintext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">split_bin</span><span class="p">:</span>
            <span class="n">plaintext</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">plaintext</span>

    <span class="c1"># single bit {0,1}</span>
    <span class="k">def</span> <span class="nf">encrypt_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bit</span><span class="p">):</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_bin_sequence</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_bin_sequence</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>

        <span class="n">m1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">))])</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">))])</span> <span class="o">%</span> <span class="mi">2</span>

        <span class="n">eq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">))])</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">))]</span>
        <span class="p">)</span>

        <span class="k">while</span> <span class="n">m1</span> <span class="o">!=</span> <span class="n">bit</span> <span class="ow">or</span> <span class="n">m2</span> <span class="o">!=</span> <span class="n">bit</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">eq</span> <span class="ow">or</span> <span class="n">r1</span> <span class="o">==</span> <span class="n">r2</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_bin_sequence</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_bin_sequence</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>

            <span class="n">m1</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">sum</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="o">%</span> <span class="mi">2</span>
            <span class="p">)</span>

            <span class="n">eq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))]</span>
            <span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">b</span><span class="p">))]</span>
            <span class="p">)</span>

        <span class="n">C1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">a1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r1</span><span class="p">))])</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">a2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r2</span><span class="p">))])</span>
        <span class="k">return</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span>

    <span class="k">def</span> <span class="nf">decrypt_bit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">C1</span><span class="p">,</span> <span class="n">C2</span> <span class="o">=</span> <span class="n">ciphertext</span>
        <span class="n">M1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">e1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">p1</span><span class="p">)</span> <span class="o">*</span> <span class="n">C1</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">p1</span>
        <span class="p">)</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">p2</span><span class="p">)</span> <span class="o">*</span> <span class="n">C2</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span><span class="o">.</span><span class="n">p2</span>
        <span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">M1</span> <span class="o">+</span> <span class="n">M2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">m</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">crypto</span> <span class="o">=</span> <span class="n">MHK2</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">MSG</span><span class="p">)</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">crypto</span><span class="o">.</span><span class="n">public_key</span><span class="o">.</span><span class="n">public_key_export</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">plaintext</span> <span class="o">==</span> <span class="n">MSG</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Bài này phức tạp :))))</p>
<section id="tao-private-key">
<h3>1. Tạo private key<a class="headerlink" href="#tao-private-key" title="Link to this heading">#</a></h3>
<p>Để tạo private key, server random hai dãy số <span class="math notranslate nohighlight">\(s_1 = (s_{11}, s_{12}, \ldots, s_{1n})\)</span> và <span class="math notranslate nohighlight">\(s_2 = (s_{21}, s_{22}, \ldots, s_{2n})\)</span> với <span class="math notranslate nohighlight">\(n = 256\)</span> và <span class="math notranslate nohighlight">\(s_{ij}\)</span> <span class="math notranslate nohighlight">\(128\)</span> bit.</p>
<p>Hệ thống sinh dãy số cho tới khi <span class="math notranslate nohighlight">\(\displaystyle{p_1 = \sum_{i=1}^n s_{1i} + 2}\)</span> là số nguyên tố, tương tự cho <span class="math notranslate nohighlight">\(\displaystyle{p_2 = \sum_{i=1}^n s_{2i} + 2}\)</span> là số nguyên tố. Sau đó hệ thống chọn ngẫu nhiên số <span class="math notranslate nohighlight">\(e_1 \in \Bigl[\dfrac{p_1}{2}, p_1\Bigl]\)</span> và <span class="math notranslate nohighlight">\(e_2 \in \Bigl[\dfrac{p_2}{2}, p_2\Bigr]\)</span>.</p>
<p>Cuối cùng tính <span class="math notranslate nohighlight">\(s = (s_{11} + s_{21}, s_{12} + s_{22}, \ldots, s_{1n} + s_{2n}) = (s_1, s_2, \ldots, s_n)\)</span>.</p>
</section>
<section id="tao-public-key">
<h3>2. Tạo public key<a class="headerlink" href="#tao-public-key" title="Link to this heading">#</a></h3>
<p>Từ hai dãy <span class="math notranslate nohighlight">\(s_1\)</span> và <span class="math notranslate nohighlight">\(s_2\)</span> ở trên hệ thống tính hai dãy <span class="math notranslate nohighlight">\(a_1 = (e_1 * s_{11}, e_1 * s_{12}, \ldots, e_1 * s_{1n})\)</span> (tất cả trong modulo <span class="math notranslate nohighlight">\(p_1\)</span>) và <span class="math notranslate nohighlight">\(a_2 = (e_2 * s_{21}, e_2 * s_{22}, \ldots, e_2 * s_{2n})\)</span> (tất cả trong modulo <span class="math notranslate nohighlight">\(p_2\)</span>).</p>
<p>Đặt <span class="math notranslate nohighlight">\(b_1 = (s_{11} \bmod 2, s_{12} \bmod 2, \ldots, s_{1n} \bmod 2)\)</span>.</p>
<p>Đặt <span class="math notranslate nohighlight">\(b_2 = (s_{21} \bmod 2, s_{22} \bmod 2, \ldots, s_{2n} \bmod 2)\)</span>.</p>
<p>Đặt <span class="math notranslate nohighlight">\(b = (s_1 \bmod 2, s_2 \bmod 2, \ldots, s_n \bmod 2)\)</span>.</p>
<p>Cuối cùng, <span class="math notranslate nohighlight">\(c\)</span> được chọn ngẫu nhiên, hoặc là <span class="math notranslate nohighlight">\(b_1\)</span>, hoặc là <span class="math notranslate nohighlight">\(b_2\)</span>.</p>
</section>
<section id="ma-hoa">
<h3>3. Mã hóa<a class="headerlink" href="#ma-hoa" title="Link to this heading">#</a></h3>
<p>Để mã hóa một bit, <span class="math notranslate nohighlight">\(\mathrm{bit} \in \{0, 1\}\)</span>, đầu tiên tạo hai dãy ngẫu nhiên <span class="math notranslate nohighlight">\(r_1 = (r_{11}, r_{12}, \ldots, r_{1n})\)</span> và <span class="math notranslate nohighlight">\(r_2 = (r_{21}, r_{22}, \ldots, r_{2n})\)</span> với <span class="math notranslate nohighlight">\(r_{ij} \in \{0, 1\}\)</span>.</p>
<p>Khi đó ciphertext là <span class="math notranslate nohighlight">\(c_1 = \sum_{i=1}^n a_{1i} * r_{1i}\)</span> và <span class="math notranslate nohighlight">\(c_2 \sum_{i=1}^n a_{2i} * r_{2i}\)</span> (điều kiện đối với <span class="math notranslate nohighlight">\(\mathrm{bit}\)</span> ở <span class="math notranslate nohighlight">\(m_1\)</span>, <span class="math notranslate nohighlight">\(m_2\)</span> và <span class="math notranslate nohighlight">\(eq\)</span> nhưng hiện tại chúng ta không cần dùng tới).</p>
</section>
<section id="khoi-phuc-private-key">
<h3>4. Khôi phục private key<a class="headerlink" href="#khoi-phuc-private-key" title="Link to this heading">#</a></h3>
<p>Chi tiết cách giải bài này mình tham khảo writeup của Google và Mystiz. Về mặt lý thuyết mình không hiểu sao họ có thể nghĩ ra lattice hay như vậy :)))) Do đó ở đây mình chỉ trình bày cách xây dựng lattice để giải bài này.</p>
<p>Ý tưởng là từ public key <span class="math notranslate nohighlight">\(a_1\)</span> (<span class="math notranslate nohighlight">\(a_2\)</span> tương tự) mình sẽ khôi phục lại <span class="math notranslate nohighlight">\(p_1\)</span> và <span class="math notranslate nohighlight">\(e_1\)</span>.</p>
<p>Đặt <span class="math notranslate nohighlight">\(A_1 = \sum_{i=1}^n a_{1i}\)</span>. Do <span class="math notranslate nohighlight">\(a_{1i} = e_1 * s_{1i} \bmod p_1\)</span> với <span class="math notranslate nohighlight">\(i = \overline{1, n}\)</span> nên <span class="math notranslate nohighlight">\(A_1 = \sum_{i=1}^n e_1 * s_{1i} = e_1 \sum_{i=1}^N s_{1i}\)</span>. Mà mình đã biết <span class="math notranslate nohighlight">\(p_1 = \sum_{i=1}^n s_{1i} + 2\)</span> nên phương trình trên tương đương với <span class="math notranslate nohighlight">\(A_1 = e_1 * (p_1 - 2)\)</span>. Lấy modulo <span class="math notranslate nohighlight">\(p_1\)</span> ta có <span class="math notranslate nohighlight">\(A_1 \equiv -2 e_1 \bmod p_1\)</span>.</p>
<p>Từ việc <span class="math notranslate nohighlight">\(a_{1i} \equiv e_1 * s_{1i} \bmod p_1\)</span>, ta có <span class="math notranslate nohighlight">\(2 a_{1i} \equiv 2 e_1 * s_{1i} \equiv -A_1 * s_{1i} \bmod p_1\)</span>.</p>
<p>Nghĩa là tồn tại số <span class="math notranslate nohighlight">\(x_{1i} \in \mathbb{Z}\)</span> sao cho <span class="math notranslate nohighlight">\(2 a_{1i} + A_1 * s_{1i} = x_{1i} * p_1\)</span> với <span class="math notranslate nohighlight">\(i = \overline{1, n}\)</span>.</p>
<p>Mình có thể đánh giá <span class="math notranslate nohighlight">\(x_{1i}\)</span> đơn giản như sau:</p>
<div class="math notranslate nohighlight">
\[x_{1i} = \dfrac{2 a_{1i} + A_1 s_{1i}}{p_1} \leqslant \dfrac{2 \max(a_{1i}) + A_1 * 2^{128}}{\max(a_{1i})}\]</div>
<p>xấp xỉ 136 bit.</p>
<p>Lấy <span class="math notranslate nohighlight">\(i=1\)</span> ta có <span class="math notranslate nohighlight">\(2 a_{11} + A_1 * s_{11} = x_{11} * p_1\)</span> (1).</p>
<p>Lấy <span class="math notranslate nohighlight">\(2 \leqslant i \leqslant n\)</span> ta có <span class="math notranslate nohighlight">\(2 a_{1i} + A_1 * s_{1i} = x_{1i} * p_1\)</span> (2).</p>
<p>Để khử <span class="math notranslate nohighlight">\(p_1\)</span> mình nhân hai vế phương trình (1) cho <span class="math notranslate nohighlight">\(x_{1i}\)</span> và nhân hai vế phương trình (2) cho <span class="math notranslate nohighlight">\(x_{11}\)</span>, rồi trừ vế theo vế thu được <span class="math notranslate nohighlight">\(2 a_{11} * x_{1i} - 2 a_{1i} * x_{11} + A_1 (s_{11} * x_{1i} - s_{1i} * x_{11}) = 0\)</span>.</p>
<p>Ở đây chúng ta đã biết <span class="math notranslate nohighlight">\(a_{11}\)</span>, <span class="math notranslate nohighlight">\(a_{1i}\)</span> và <span class="math notranslate nohighlight">\(A_1\)</span>. Việc xây dựng lattice sẽ dựa trên các hệ số <span class="math notranslate nohighlight">\(x_{1i}\)</span>, <span class="math notranslate nohighlight">\(x_{11}\)</span> và <span class="math notranslate nohighlight">\(s_{11} * x_{1i} - s_{1i} * s_{11}\)</span>. Do đó mình viết</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{ccc}
    x_{11} &amp; * &amp; (\ldots, -2a_{1i}, \ldots) \\ 
    x_{1i} &amp; * &amp; (\ldots, 2a_{11}, \ldots) \\ 
    \ldots &amp; * &amp; (\ldots, \ldots, \ldots) \\ 
    (s_{11} * x_{1i} - s_{1i} * x_{11}) &amp; * &amp; (\ldots, A_1, \ldots) \\ 
    \ldots &amp; * &amp; (\ldots, \ldots, \ldots)
\end{array}\end{split}\]</div>
<p>Với <span class="math notranslate nohighlight">\(i = \overline{2, n}\)</span> thì mình sẽ cần <span class="math notranslate nohighlight">\(255\)</span> cột. Tuy nhiên chúng ta thường sử dụng <span class="math notranslate nohighlight">\(1\)</span> để khi tính ra lattice thì sẽ thu được số cần tìm, cụ thể ở đây là <span class="math notranslate nohighlight">\(x_{11}\)</span> và <span class="math notranslate nohighlight">\(s_{11} * x_{1i} - s_{1i} * x_{11}\)</span>. Do đó mình sẽ modify nhẹ lại lattice trên thành</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{ccc}
    x_{11} &amp; * &amp; (1, \ldots, -2a_{1i}, \ldots) \\ 
    x_{1i} &amp; * &amp; (\ldots, \ldots, 2a_{11}, \ldots) \\ 
    \ldots &amp; * &amp; (\ldots, \ldots, \ldots, \ldots) \\ 
    (s_{11} * x_{1i} - s_{1i} * x_{11}) &amp; * &amp; (0, 1, \ldots, A_1, \ldots) \\ 
    \ldots &amp; * &amp; (\ldots, \ldots, \ldots, \ldots)
\end{array}\end{split}\]</div>
<p>Ở dòng <span class="math notranslate nohighlight">\(s_{11} * x_{1i} - s_{1i} * x_{11}\)</span> chúng ta không muốn nó đụng độ với số <span class="math notranslate nohighlight">\(x_{11}\)</span> bên trên nên sẽ dịch qua phải một ô. Ta cần <span class="math notranslate nohighlight">\(255\)</span> cột như vậy vì sẽ có <span class="math notranslate nohighlight">\(i=\overline{2, 256}\)</span>. Và để sắp xếp <span class="math notranslate nohighlight">\(-2 a_{1i}\)</span> cũng cần <span class="math notranslate nohighlight">\(255\)</span> cột như đã nói ở trên. Vậy lattice này có <span class="math notranslate nohighlight">\(1 + 255 + 255 = 511\)</span> cột và cũng là số hàng. Lattice như vậy sẽ có dạng ma trận như sau</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix}1 &amp; 0 &amp; 0 &amp; \ldots &amp; -2a_{12} &amp; -2a_{13} &amp; \ldots \\ 0 &amp; 0 &amp; 0 &amp; \ldots &amp; 2a_{11} &amp; 0 &amp; \ldots \\ 0 &amp; 0 &amp; 0 &amp; \ldots &amp; 0 &amp; 2a_{11} &amp; \ldots \\ \ldots &amp; \ldots &amp; \ldots &amp; \ldots &amp; \ldots &amp; \ldots &amp; \ldots \\ 0 &amp; 1 &amp; \ldots &amp; \ldots &amp; A_1 &amp; 0 &amp; \ldots \\ 0 &amp; 0 &amp; 1 &amp; \ldots &amp; 0 &amp; A_1 &amp; \ldots \\ \ldots &amp; \ldots &amp; \ldots &amp; \ldots &amp; \ldots &amp; \ldots &amp; \ldots \\ \end{pmatrix}\end{split}\]</div>
<p>Tới lúc này chúng ta đã hoàn thành … 10% chặng đường. Lý do là vì với lattice này chúng ta không thể giải ra short vector mong muốn được. Dựa trên lattice mình hy vọng sẽ chạy ra vector</p>
<p><span class="math notranslate nohighlight">\(v = (x_{11}, s_{11} * x_{12} - s_{12} * x_{11}, \ldots, s_{11} * x_{1n} - s_{1n} * x_{11}, 0, 0, \ldots, 0)\)</span></p>
<p>Tuy nhiên cần nhớ rằng <span class="math notranslate nohighlight">\(s_{1i}\)</span> có <span class="math notranslate nohighlight">\(128\)</span> bit và <span class="math notranslate nohighlight">\(x_{1i}\)</span> xấp xỉ <span class="math notranslate nohighlight">\(136\)</span> bit. Bằng tính toán có thể thấy <span class="math notranslate nohighlight">\(s_{11} * x_{1i} - s_{1i} * x_{11}\)</span> cũng có 128 bit. Như vậy chúng ta cần scale lattice trên để các giá trị không sai khác nhau quá lớn.</p>
<p>Cụ thể, do <span class="math notranslate nohighlight">\(x_{11}\)</span> có <span class="math notranslate nohighlight">\(136\)</span> bit nên ta sẽ nhân với <span class="math notranslate nohighlight">\(\dfrac{1}{2^{136}}\)</span>, do <span class="math notranslate nohighlight">\(s_{11} * x_{1i} - s_{1i} * x_{11}\)</span> có <span class="math notranslate nohighlight">\(128\)</span> bit nên ta sẽ nhân với <span class="math notranslate nohighlight">\(\dfrac{1}{2^{128}}\)</span>. Đối với <span class="math notranslate nohighlight">\(-2a_{1i}\)</span>, <span class="math notranslate nohighlight">\(2a_{11}\)</span> và <span class="math notranslate nohighlight">\(A_1\)</span> thì mình cần chúng lớn để lattice tìm ra short vector, nên nhân với <span class="math notranslate nohighlight">\(2^{1024}\)</span>.</p>
<p>Sử dụng tính chất</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix} a_{11} &amp; a_{12} &amp; \ldots &amp; a_{1n} \\ a_{21} &amp; a_{22} &amp; \ldots &amp; a_{2n} \\ \ldots &amp; \ldots &amp; \ldots &amp; \ldots \\ a_{n1} &amp; a_{n2} &amp; \ldots &amp; a_{nn} \end{pmatrix} \times \begin{pmatrix} b_1 &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; b_2 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; \ddots &amp; 0 \\ 0 &amp; 0 &amp; 0 &amp; b_n \end{pmatrix} = \begin{pmatrix} a_{11} b_1 &amp; a_{12} b_2 &amp; \ldots &amp; a_{1n} b_n \\ a_{21} b_1 &amp; a_{22} b_2 &amp; \ldots &amp; a_{2n} b_n \\ \ldots &amp; \ldots &amp; \ldots &amp; \ldots \\ a_{n1} b_1 &amp; a_{n2} b_2 &amp; \ldots &amp; a_{nn} b_n \end{pmatrix}\end{split}\]</div>
<p>Mình sẽ nhân lattice trên với ma trận sau là sẽ scale được hệ số theo nhu cầu</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix}\dfrac{1}{2^{136}} &amp; &amp; &amp; &amp; &amp; &amp; \\ &amp; \dfrac{1}{2^{128}} &amp; &amp; &amp; &amp; &amp; \\ &amp; &amp; \ddots &amp; \dfrac{1}{2^{128}} &amp; &amp; &amp; &amp; \\ &amp; &amp; &amp; &amp; 2^{1024} &amp; &amp; \\ &amp; &amp; &amp; &amp; &amp; \ddots &amp; \\ &amp; &amp; &amp; &amp; &amp; &amp; 2^{1024}\end{pmatrix}\end{split}\]</div>
<p>Phần tử đầu tiên của short vector là <span class="math notranslate nohighlight">\(x_{11}\)</span> (có lẽ vậy :v). Thật ra thì phần tử đầu tiên của short vector là <span class="math notranslate nohighlight">\(x_{11} \bmod a_{11}\)</span> hoặc <span class="math notranslate nohighlight">\(-x_{11} \bmod a_{11}\)</span>. Phía trên mình đã tính được chặn trên của <span class="math notranslate nohighlight">\(x_{11}\)</span> là <span class="math notranslate nohighlight">\(\dfrac{2 \max(a_{1i}) + A_1 * 2^{128}}{\max(a_{1i})}\)</span>. Từ đây mình duyệt vòng for qua các giá trị <span class="math notranslate nohighlight">\(x_{11} + k a_{11}\)</span> và <span class="math notranslate nohighlight">\(-x_{11} + k a_{11}\)</span> để tìm các số <span class="math notranslate nohighlight">\(s_{1i}\)</span> theo cách sau</p>
<section id="a-khoi-phuc-modulo">
<h4>a. Khôi phục modulo<a class="headerlink" href="#a-khoi-phuc-modulo" title="Link to this heading">#</a></h4>
<p>Nhắc lại <span class="math notranslate nohighlight">\(2 a_{11} + A_1 * s_{11} = x_{11} * p_1\)</span>. Modulo hai vế cho <span class="math notranslate nohighlight">\(A_1\)</span> thì được <span class="math notranslate nohighlight">\(2 a_{11} = x_{11} * p_1 \bmod A_1\)</span>. Ở đây có thể tìm được <span class="math notranslate nohighlight">\(p_1 = 2a_{11} x_{11}^{-1} \bmod A_1\)</span>. Tuy nhiên chúng ta cần lưu ý rằng điều kiện để tồn tại nghịch đảo là <span class="math notranslate nohighlight">\(\gcd(x_{11}, A_1) = 1\)</span>. Do đó để đảm bảo chúng ta tính toán thêm một bước.</p>
<p>Đặt <span class="math notranslate nohighlight">\(g = \gcd(2a_{11}, A_1)\)</span>. Khi đó phương trình đồng dư có nghiệm khi và chỉ khi <span class="math notranslate nohighlight">\(\gcd(x_{11} * p_1, A_1)\)</span> chia hết cho <span class="math notranslate nohighlight">\(g\)</span>. Sau khi thỏa các điều kiện này, đặt <span class="math notranslate nohighlight">\(\dfrac{A_1}{g} = A_1'\)</span>, <span class="math notranslate nohighlight">\(2 a_{11}' = \dfrac{2a_{11}}{g} \bmod \dfrac{A_1}{g}\)</span>, và <span class="math notranslate nohighlight">\(x_{11}' = \dfrac{x_{11}}{g} \bmod \dfrac{A_1}{g}\)</span>. Khi đó <span class="math notranslate nohighlight">\(p_1 = 2a_{11}' * x_{11}'^{-1} \bmod A_1'\)</span>.</p>
</section>
<section id="b-khoi-phuc-e">
<h4>b. Khôi phục e<a class="headerlink" href="#b-khoi-phuc-e" title="Link to this heading">#</a></h4>
<p>Bên trên mình đã có <span class="math notranslate nohighlight">\(A_1 = -2e_1 \bmod p_1\)</span> nên mình sẽ tìm được <span class="math notranslate nohighlight">\(e_1\)</span>. Sau đó từ <span class="math notranslate nohighlight">\(a_1 = (a_{11}, a_{12}, \ldots, a_{1n})\)</span> và <span class="math notranslate nohighlight">\(e_1\)</span> mình tính lại được tất cả <span class="math notranslate nohighlight">\(s_{1i}\)</span> và kiểm tra xem <span class="math notranslate nohighlight">\(\sum_{i=1}^n s_i + 2 \equiv p_1\)</span>, đồng thời không có số <span class="math notranslate nohighlight">\(s_{1i}\)</span> nào vượt quá <span class="math notranslate nohighlight">\(128\)</span> bit.</p>
</section>
<section id="c-code-giai">
<h4>c. Code giải<a class="headerlink" href="#c-code-giai" title="Link to this heading">#</a></h4>
<p>Đoạn code mình lấy của Google. Lưu ý rằng sau khi LLL xong mình cần scale ngược lại độ lớn ban đầu, ở đây là chia cho ma trận <span class="math notranslate nohighlight">\(Q\)</span>. Do một chút lười nên ở đây thay <code class="docutils literal notranslate"><span class="pre">a2</span></code> thành <code class="docutils literal notranslate"><span class="pre">a_1</span></code> để áp dụng cho <span class="math notranslate nohighlight">\(p_1\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="mi">511</span><span class="p">)</span>
<span class="n">sum_a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">256</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">256</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mi">256</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_a</span>

<span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">^</span><span class="mi">136</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">^</span><span class="mi">128</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="o">^</span><span class="mi">1024</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">)]</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">diagonal_matrix</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

<span class="n">M</span> <span class="o">*=</span> <span class="n">Q</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">LLL</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done LLL!&quot;</span><span class="p">)</span>
<span class="n">M</span> <span class="o">/=</span> <span class="n">Q</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">:</span>
    <span class="n">x0_</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">256</span><span class="p">]</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">256</span><span class="p">:]</span>

    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">)]:</span> <span class="k">continue</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>

    <span class="n">x0_bound</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sum_a</span> <span class="o">*</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="p">)</span> <span class="o">//</span> <span class="nb">max</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">+</span><span class="n">x0_</span><span class="p">,</span> <span class="n">x0_bound</span><span class="p">,</span> <span class="o">+</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sum_a</span>
        <span class="c1">#print(u, v, m)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">u</span> <span class="o">//</span> <span class="n">g</span><span class="p">,</span> <span class="n">v</span> <span class="o">//</span> <span class="n">g</span><span class="p">,</span> <span class="n">m</span> <span class="o">//</span> <span class="n">g</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">m</span><span class="p">)(</span><span class="n">v</span><span class="o">/</span><span class="n">u</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">p1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">p1</span><span class="p">)(</span><span class="o">-</span><span class="n">sum_a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">p1</span><span class="p">)(</span><span class="n">a_</span><span class="o">/</span><span class="n">e</span><span class="p">))</span> <span class="k">for</span> <span class="n">a_</span> <span class="ow">in</span> <span class="n">a2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">p1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="p">:</span> <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found! p = </span><span class="si">{</span><span class="n">p1</span><span class="si">}</span><span class="s2">, e = </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">x0_</span><span class="p">,</span> <span class="n">x0_bound</span><span class="p">,</span> <span class="o">+</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">a2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sum_a</span>
        <span class="c1">#print(u, v, m)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gcd</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">u</span> <span class="o">//</span> <span class="n">g</span><span class="p">,</span> <span class="n">v</span> <span class="o">//</span> <span class="n">g</span><span class="p">,</span> <span class="n">m</span> <span class="o">//</span> <span class="n">g</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">m</span><span class="p">)(</span><span class="n">v</span><span class="o">/</span><span class="n">u</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">p1</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_prime</span><span class="p">(</span><span class="n">p1</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">e</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">p1</span><span class="p">)(</span><span class="o">-</span><span class="n">sum_a</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">gcd</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">p1</span><span class="p">)(</span><span class="n">a_</span><span class="o">/</span><span class="n">e</span><span class="p">))</span> <span class="k">for</span> <span class="n">a_</span> <span class="ow">in</span> <span class="n">a2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">p1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">^</span><span class="mi">128</span><span class="p">:</span> <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found! p = </span><span class="si">{</span><span class="n">p1</span><span class="si">}</span><span class="s2">, e = </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
</div>
<p>Cuối cùng chạy decrypt và lấy flag thôi.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># CTF{faNNYPAcKs_ARe_4maZiNg_AnD_und3Rr@t3d}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="mytls">
<h2>MYTLS<a class="headerlink" href="#mytls" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Copyright 2023 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>


<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">cryptography</span> <span class="kn">import</span> <span class="n">x509</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hmac</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">ec</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">padding</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.kdf.hkdf</span> <span class="kn">import</span> <span class="n">HKDF</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">secrets</span> <span class="kn">import</span> <span class="n">token_hex</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/app/flag.txt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">_FLAG</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="s1">&#39;/app/flag.txt&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">print_encrypted</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
  <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
      <span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">input_encrypted</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
  <span class="c1"># Getting the CA cert.</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;ca-crt.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ca_file</span><span class="p">:</span>
    <span class="n">ca</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">ca_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
  <span class="c1"># Getting the server cert.</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;server-ecdhcert.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">server_cert_file</span><span class="p">:</span>
    <span class="n">server_cert_content</span> <span class="o">=</span> <span class="n">server_cert_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">server_cert</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">server_cert_content</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">server_cert_content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="c1"># Checking the server key, just to be sure.</span>
  <span class="n">ca</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
      <span class="n">server_cert</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
      <span class="n">server_cert</span><span class="o">.</span><span class="n">tbs_certificate_bytes</span><span class="p">,</span>
      <span class="n">padding</span><span class="o">.</span><span class="n">PKCS1v15</span><span class="p">(),</span>
      <span class="n">server_cert</span><span class="o">.</span><span class="n">signature_hash_algorithm</span><span class="p">)</span>
  <span class="c1"># Getting the server private key.</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;server-ecdhkey.pem&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">server_key_file</span><span class="p">:</span>
    <span class="n">server_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">server_key_file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                                                    <span class="kc">None</span><span class="p">,</span> <span class="n">default_backend</span><span class="p">())</span>
  <span class="c1"># Getting the client cert.</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please provide the client certificate in PEM format:&#39;</span><span class="p">)</span>
  <span class="n">client_cert_content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">client_cert_line</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">while</span> <span class="n">client_cert_line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
    <span class="n">client_cert_line</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
    <span class="n">client_cert_content</span> <span class="o">+=</span> <span class="n">client_cert_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
  <span class="n">client_cert</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_certificate</span><span class="p">(</span>
      <span class="n">client_cert_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="c1"># Checking the client key, this is important. We don&#39;t want fakes here!</span>
  <span class="n">ca</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
      <span class="n">client_cert</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
      <span class="n">client_cert</span><span class="o">.</span><span class="n">tbs_certificate_bytes</span><span class="p">,</span>
      <span class="n">padding</span><span class="o">.</span><span class="n">PKCS1v15</span><span class="p">(),</span>
      <span class="n">client_cert</span><span class="o">.</span><span class="n">signature_hash_algorithm</span><span class="p">)</span>

  <span class="c1"># Get ephemeral client random</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please provide the ephemeral client random:&#39;</span><span class="p">)</span>
  <span class="n">client_ephemeral_random</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">client_ephemeral_random</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: invalid client random length&#39;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

  <span class="c1"># Get ephemeral client key</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please provide the ephemeral client key:&#39;</span><span class="p">)</span>
  <span class="n">client_ephemeral_key_content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">client_ephemeral_key_line</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">while</span> <span class="n">client_ephemeral_key_line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
    <span class="n">client_ephemeral_key_line</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
    <span class="n">client_ephemeral_key_content</span> <span class="o">+=</span> <span class="n">client_ephemeral_key_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
  <span class="n">client_ephemeral_public_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span>
      <span class="n">client_ephemeral_key_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

  <span class="c1"># Generate ephemeral server random</span>
  <span class="n">server_ephemeral_random</span> <span class="o">=</span> <span class="n">token_hex</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Server ephemeral random:&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">server_ephemeral_random</span><span class="p">)</span>

  <span class="c1"># Generate ephemeral server key</span>
  <span class="n">server_ephemeral_key</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">SECP256R1</span><span class="p">(),</span>
                                                 <span class="n">default_backend</span><span class="p">())</span>
  <span class="n">server_ephemeral_public_key</span> <span class="o">=</span> <span class="n">server_ephemeral_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Server ephemeral key:&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">server_ephemeral_public_key</span><span class="o">.</span><span class="n">public_bytes</span><span class="p">(</span>
      <span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">PEM</span><span class="p">,</span>
      <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="o">.</span><span class="n">PublicFormat</span><span class="o">.</span><span class="n">SubjectPublicKeyInfo</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

  <span class="n">server_ephemeral_secret</span> <span class="o">=</span> <span class="n">server_ephemeral_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span>
      <span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">client_ephemeral_public_key</span><span class="p">)</span>
  <span class="n">server_secret</span> <span class="o">=</span> <span class="n">server_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">client_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
  <span class="n">derived_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
                     <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                     <span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;SaltyMcSaltFace&#39;</span><span class="p">,</span>
                     <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;mytls&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span>
                         <span class="n">server_ephemeral_secret</span> <span class="o">+</span>
                         <span class="n">server_secret</span> <span class="o">+</span>
                         <span class="n">client_ephemeral_random</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="o">+</span>
                         <span class="n">server_ephemeral_random</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please provide the client HMAC:&#39;</span><span class="p">)</span>
  <span class="n">client_hmac_content</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
  <span class="n">client_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
  <span class="n">client_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;client myTLS successful!&#39;</span><span class="p">)</span>
  <span class="n">client_hmac</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">client_hmac_content</span><span class="p">))</span>

  <span class="n">server_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
  <span class="n">server_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;server myTLS successful!&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Server HMAC:&#39;</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">server_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

  <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Hello guest!&#39;</span>
  <span class="k">if</span> <span class="s1">&#39;CN=admin.mytls&#39;</span> <span class="ow">in</span> <span class="n">client_cert</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">rfc4514_string</span><span class="p">():</span>
      <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Hello admin! &#39;</span> <span class="o">+</span> <span class="n">_FLAG</span>

  <span class="n">print_encrypted</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">server_ephemeral_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>
  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">print_encrypted</span><span class="p">(</span>
        <span class="s1">&#39;Welcome to our write-only file storage!</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="s1">&#39;Select the storage slot [0-9]:&#39;</span><span class="p">,</span>
        <span class="n">server_ephemeral_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>
    <span class="n">storage_slot</span> <span class="o">=</span> <span class="n">input_encrypted</span><span class="p">(</span><span class="n">server_ephemeral_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/tmp/storage/&#39;</span><span class="p">,</span> <span class="n">storage_slot</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">print_encrypted</span><span class="p">(</span><span class="s1">&#39;Gimme your secrets:&#39;</span><span class="p">,</span> <span class="n">server_ephemeral_random</span><span class="p">,</span>
                    <span class="n">derived_key</span><span class="p">)</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">input_encrypted</span><span class="p">(</span><span class="n">server_ephemeral_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;sha256&#39;</span><span class="p">)</span>
      <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
      <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
      <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">secret</span><span class="p">)</span>
      <span class="n">print_encrypted</span><span class="p">(</span><span class="s1">&#39;Saved! Previous secret reference: &#39;</span> <span class="o">+</span> <span class="n">prev_hash</span><span class="p">,</span>
                      <span class="n">server_ephemeral_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Bài này dựa trên nguyên lý handshake của TLS (mãi sau mình đàm đạo với các bạn khác mới biết :v). Trong bài này đề cho các file sau:</p>
<ul class="simple">
<li><p>admin-ecdhcert.pem</p></li>
<li><p>ca-crt.pem</p></li>
<li><p>Dockerfile</p></li>
<li><p>guest-ecdhcert.pem</p></li>
<li><p>guest-ecdhkey.pem</p></li>
<li><p>server-ecdhcert.pem</p></li>
<li><p><a class="reference external" href="http://server.py">server.py</a></p></li>
<li><p><a class="reference external" href="http://start.sh">start.sh</a></p></li>
</ul>
<p>Ở bài này xảy ra hai công đoạn trao đổi khóa, mình sẽ gọi <code class="docutils literal notranslate"><span class="pre">share_key</span></code> và <code class="docutils literal notranslate"><span class="pre">share_ephemeral_key</span></code>.</p>
<p>Đối với <code class="docutils literal notranslate"><span class="pre">share_ephemeral_key</span></code>, mình sẽ cần gửi lên một chuỗi hex độ dài <span class="math notranslate nohighlight">\(32\)</span> ký tự, và một public key ECDH theo dạng PEM. Server cũng sẽ tạo một chuỗi hex độ dài <span class="math notranslate nohighlight">\(32\)</span> ký tự, private key và public key ECDH, sau đó gửi public key ECDH này về cho mình cũng ở dạng PEM.</p>
<p>Khi đó <code class="docutils literal notranslate"><span class="pre">share_ephemeral_key</span></code> sẽ được tính là</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">server_ephemeral_secret</span> <span class="o">=</span> <span class="n">client_ephemeral_private_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span>
    <span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_ephemeral_public_key</span><span class="p">)</span>
</pre></div>
</div>
<p>Điều này là tương đương với đoạn code sau của đề vì việc trao đổi khóa sẽ giống nhau ở hai bên trao đổi khóa.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">server_ephemeral_secret</span> <span class="o">=</span> <span class="n">server_ephemeral_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span>
      <span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">client_ephemeral_public_key</span><span class="p">)</span>
</pre></div>
</div>
<p>Do đó mình chỉ cần tạo một ECDH key mỗi lần trao đổi khóa, hoặc tạo một lần cũng được.</p>
<p>Tiếp theo là <code class="docutils literal notranslate"><span class="pre">share_key</span></code>.</p>
<p>Ở đầu bài, mình sẽ cần cung cấp một public key (certificate) cho server. Server sẽ sử dụng ca-crt.pem để verify xem cert của mình có hợp lệ không (có được ký bởi CA không). Server cũng sẽ đọc private key tương ứng (ở file <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code>) và tiến hành trao đổi khóa ECDH lần hai.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">server_secret</span> <span class="o">=</span> <span class="n">server_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">client_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
</pre></div>
</div>
<p>Đoạn code trên thực hiện việc thực hiện trao đổi khóa với certificate (public key) nhận từ client, và server private key.</p>
<p>Mình thấy rằng đề đã cung cấp cho mình hai file cert và key của guest đã được ký bởi CA. Do đó mình dùng <code class="docutils literal notranslate"><span class="pre">guest-ecdhcert.pem</span></code> làm <code class="docutils literal notranslate"><span class="pre">client_cert</span></code>, và đề cũng đã cho mình <code class="docutils literal notranslate"><span class="pre">server-ecdhcert.pem</span></code> nên mình có thể tính toán khóa trao đổi ở phía mình.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">server_secret</span> <span class="o">=</span> <span class="n">client_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_cert</span><span class="o">.</span><span class="n">public_key</span><span class="p">())</span>
</pre></div>
</div>
<p>Đoạn code sau đây sẽ thực hiện việc bắt tay trên TLS.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&quot;mytls.2023.ctfcompetition.com&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the client certificate in PEM format:&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;guest-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

<span class="c1"># Exchange ECDH</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the ephemeral client random:&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the ephemeral client key:&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;client-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

<span class="c1"># Get server ephemeral public key</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server ephemeral random:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">server_random</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server ephemeral key:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">server_cert</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span> <span class="k">break</span>
    <span class="n">server_cert</span> <span class="o">+=</span> <span class="n">data</span>

<span class="n">server_cert</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span><span class="n">server_cert</span><span class="p">)</span>
<span class="c1"># Load client epehmeral private key</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;client-ecdhkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">client_ephemeral_private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
        <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_backend</span><span class="p">()</span>
    <span class="p">)</span>

<span class="c1"># Calculate shared key</span>
<span class="n">server_ephemeral_secret</span> <span class="o">=</span> <span class="n">client_ephemeral_private_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_cert</span><span class="p">)</span>

<span class="c1"># Exchange cert and key</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;server-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="c1">#server_public_key = serialization.load_pem_public_key(f.read())</span>
    <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">server_public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>
    <span class="c1">#print(server_public_key)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;guest-ecdhkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">client_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
    
<span class="n">server_secret</span> <span class="o">=</span> <span class="n">client_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_public_key</span><span class="p">)</span>

<span class="n">derived_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
                <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;SaltyMcSaltFace&#39;</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;mytls&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span>
                    <span class="n">server_ephemeral_secret</span> <span class="o">+</span>
                    <span class="n">server_secret</span> <span class="o">+</span>
                    <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span>
                    <span class="n">server_random</span>
                <span class="p">)</span>

<span class="c1">#print(server_random)</span>
<span class="c1">#print(client_ephemeral_secret, len(client_ephemeral_secret))</span>
<span class="c1">#print(server_secret, len(server_secret))</span>
<span class="n">client_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<span class="n">client_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;client myTLS successful!&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the client HMAC:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">client_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="n">server_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<span class="n">server_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;server myTLS successful!&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server HMAC:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">server_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</pre></div>
</div>
<p>Tuy nhiên tới đây chúng ta vấp phải một vấn đề, đó là subject được ký trên certificate phải là <code class="docutils literal notranslate"><span class="pre">admin.tls</span></code>, trong khi nếu sử dụng <code class="docutils literal notranslate"><span class="pre">guest-ecdhcert.pem</span></code> thì subject là <code class="docutils literal notranslate"><span class="pre">guest.tls</span></code>. Hmm tình hình có vẻ khá phức tạp. Tới đây thì mình chịu chết, sau giải mới làm ra :D</p>
<p>Khi nhìn vào file Docker, mình thấy rằng file <code class="docutils literal notranslate"><span class="pre">server-ecdhkey</span></code>.pem cũng được chép vào container. Từ đó, ở mỗi lần chạy vòng lặp, mình sẽ chỉ định path của file thành <code class="docutils literal notranslate"><span class="pre">../../app/server-ecdhkey.pem</span></code> để thoát khỏi path <code class="docutils literal notranslate"><span class="pre">/tmp/storage</span></code>, vì khi đó mình sẽ “đọc” được một ít thông tin nào đó từ <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code>.</p>
<p>Do <code class="docutils literal notranslate"><span class="pre">server-ecdhcert.pem</span></code> có <span class="math notranslate nohighlight">\(241\)</span> bytes, mình đoán rằng <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code> cũng có <span class="math notranslate nohighlight">\(241\)</span> bytes. Do đó chiến thuật của mình là ghi đè lên <span class="math notranslate nohighlight">\(240\)</span> bytes đầu của <code class="docutils literal notranslate"><span class="pre">server-ecdh.pem</span></code>, server sẽ trả về hash <code class="docutils literal notranslate"><span class="pre">H(240_bytes_ghi_đè</span> <span class="pre">||</span> <span class="pre">byte_cuối)</span></code>. Mình có thể bruteforce byte cuối với <span class="math notranslate nohighlight">\(240\)</span> bytes ghi đè ban đầu fix sẵn.</p>
<p>Sau đó mình connect lại. Với byte cuối đã biết, mình sẽ bruteforce byte kế cuối với <span class="math notranslate nohighlight">\(239\)</span> bytes ghi đè. Lúc này server trả về hash <code class="docutils literal notranslate"><span class="pre">H(239_bytes_ghi_đè</span> <span class="pre">||</span> <span class="pre">byte_kế_cuối</span> <span class="pre">||</span> <span class="pre">byte_cuối)</span></code>.</p>
<p>Như vậy mình bruteforce từ dưới lên với công thức <code class="docutils literal notranslate"><span class="pre">((240-số</span> <span class="pre">bytes</span> <span class="pre">đã</span> <span class="pre">biết)</span> <span class="pre">||</span> <span class="pre">byte_cần_brute</span> <span class="pre">||</span> <span class="pre">bytes_đã_biết)</span></code> (có 241 bytes).</p>
<p>Full code để bruteforce <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">ec</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.kdf.hkdf</span> <span class="kn">import</span> <span class="n">HKDF</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hmac</span>
<span class="kn">from</span> <span class="nn">cryptography</span> <span class="kn">import</span> <span class="n">x509</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="c1">#context.log_level = &#39;Debug&#39;</span>

<span class="k">def</span> <span class="nf">print_encrypted</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
  <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
      <span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
  <span class="c1">#print(binascii.hexlify(payload).decode(&#39;utf-8&#39;))</span>
  <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_decrypted</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
  <span class="c1">#message = message.encode(&#39;utf-8&#39;)</span>
  <span class="n">message</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">payload</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">input_encrypted</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">key_path</span> <span class="o">=</span> <span class="s2">&quot;../../app/server-ecdhkey.pem&quot;</span>
<span class="n">known</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&quot;mytls.2023.ctfcompetition.com&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the client certificate in PEM format:&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;guest-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

    <span class="c1"># Exchange ECDH</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the ephemeral client random:&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the ephemeral client key:&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;client-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

    <span class="c1"># Get server ephemeral public key</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server ephemeral random:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">server_random</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server ephemeral key:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">server_cert</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">server_cert</span> <span class="o">+=</span> <span class="n">data</span>

    <span class="n">server_cert</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span><span class="n">server_cert</span><span class="p">)</span>
    <span class="c1"># Load client epehmeral private key</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;client-ecdhkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">client_ephemeral_private_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
            <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">default_backend</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># Calculate shared key</span>
    <span class="n">server_ephemeral_secret</span> <span class="o">=</span> <span class="n">client_ephemeral_private_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_cert</span><span class="p">)</span>

    <span class="c1"># Exchange cert and key</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;server-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">server_public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;guest-ecdhkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">client_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
        
    <span class="n">server_secret</span> <span class="o">=</span> <span class="n">client_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_public_key</span><span class="p">)</span>

    <span class="n">derived_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
                    <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                    <span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;SaltyMcSaltFace&#39;</span><span class="p">,</span>
                    <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;mytls&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span>
                        <span class="n">server_ephemeral_secret</span> <span class="o">+</span>
                        <span class="n">server_secret</span> <span class="o">+</span>
                        <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span>
                        <span class="n">server_random</span>
                    <span class="p">)</span>

    <span class="n">client_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="n">client_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;client myTLS successful!&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the client HMAC:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">client_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="n">server_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
    <span class="n">server_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;server myTLS successful!&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server HMAC:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">server_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># now ignore</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">print_decrypted</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>
    <span class="n">storage_slot</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">print_encrypted</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">print_decrypted</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span>

    <span class="n">overwrite_payload</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">240</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">known</span><span class="p">))</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">print_encrypted</span><span class="p">(</span><span class="n">overwrite_payload</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">print_decrypted</span><span class="p">(</span>
        <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
        <span class="n">server_random</span><span class="p">,</span>
        <span class="n">derived_key</span><span class="p">)</span>
    <span class="c1">#print(prev_hash)</span>
    <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">prev_hash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prev_hash</span><span class="p">)</span>

    <span class="c1"># Phase 2</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">print_decrypted</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">))</span>
    <span class="n">storage_slot</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">print_encrypted</span><span class="p">(</span><span class="n">key_path</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">print_decrypted</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">))</span>

    <span class="c1">#overwrite_payload = &quot;A&quot;*240</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">print_encrypted</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">print_decrypted</span><span class="p">(</span>
        <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
        <span class="n">server_random</span><span class="p">,</span>
        <span class="n">derived_key</span><span class="p">)</span>
    <span class="c1">#print(prev_hash)</span>
    <span class="n">prev_hash</span> <span class="o">=</span> <span class="n">prev_hash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prev_hash</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;sha256&quot;</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">overwrite_payload</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">known</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="n">prev_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">():</span>
            <span class="n">known</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">known</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">known</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">known</span><span class="p">)</span> <span class="o">==</span> <span class="mi">241</span><span class="p">:</span>
        <span class="k">break</span>

<span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Sau khi đã có <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code>, mình quay lại bypass phần kiểm tra subject của certificate. Trong các file cert được cho thì có <code class="docutils literal notranslate"><span class="pre">admin-ecdhcert.pem</span></code> là có subject chúng ta cần (CN=admin.tls). Mình đã có <code class="docutils literal notranslate"><span class="pre">server-ecdhcert.pem</span></code> và <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code> (vừa leak) để tiến hành trao đổi khóa. Tuy nhiên <code class="docutils literal notranslate"><span class="pre">server-ecdhcert.pem</span></code> thì lại không có CN=admin.tls.</p>
<p>Ở đây mình gửi lên <code class="docutils literal notranslate"><span class="pre">admin-ecdhcert.pem</span></code>, nhưng khi tính khóa trao đổi thì sử dụng <code class="docutils literal notranslate"><span class="pre">server-ecdhkey.pem</span></code> (không gửi <code class="docutils literal notranslate"><span class="pre">server-ecdhcert.pem</span></code>) và nó đã work!!! Đọc writeup của mọi người thì họ gọi là KCI attack do tính chất trao đổi khóa Diffie-Hellman.</p>
<p>Mình sửa đổi một tí file trên để lấy flag (gửi lên cert là <code class="docutils literal notranslate"><span class="pre">admin-ecdhcert.pem</span></code> và dùng <code class="docutils literal notranslate"><span class="pre">server-ecdhkey</span></code> để tính <code class="docutils literal notranslate"><span class="pre">share_key</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">ec</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.kdf.hkdf</span> <span class="kn">import</span> <span class="n">HKDF</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hmac</span>
<span class="kn">from</span> <span class="nn">cryptography</span> <span class="kn">import</span> <span class="n">x509</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;Debug&#39;</span>

<span class="k">def</span> <span class="nf">print_encrypted</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
  <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
      <span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
  <span class="c1">#print(binascii.hexlify(payload).decode(&#39;utf-8&#39;))</span>
  <span class="k">return</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">print_decrypted</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
  <span class="c1">#message = message.encode(&#39;utf-8&#39;)</span>
  <span class="n">message</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">payload</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">input_encrypted</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
  <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
      <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
      <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">iv</span><span class="p">)))</span>
  <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&quot;mytls.2023.ctfcompetition.com&quot;</span><span class="p">,</span> <span class="mi">1337</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the client certificate in PEM format:&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;admin-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

<span class="c1"># Exchange ECDH</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the ephemeral client random:&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the ephemeral client key:&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;client-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">()</span>

<span class="c1"># Get server ephemeral public key</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server ephemeral random:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">server_random</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server ephemeral key:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">server_cert</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span> <span class="k">break</span>
    <span class="n">server_cert</span> <span class="o">+=</span> <span class="n">data</span>

<span class="n">server_cert</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_public_key</span><span class="p">(</span><span class="n">server_cert</span><span class="p">)</span>
<span class="c1"># Load client epehmeral private key</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;client-ecdhkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">client_secret</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span>
        <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_backend</span><span class="p">()</span>
    <span class="p">)</span>

<span class="c1"># Calculate shared key</span>
<span class="n">server_ephemeral_secret</span> <span class="o">=</span> <span class="n">client_secret</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_cert</span><span class="p">)</span>

<span class="c1"># Exchange cert and key</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;admin-ecdhcert.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">x509</span><span class="o">.</span><span class="n">load_pem_x509_certificate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">server_public_key</span> <span class="o">=</span> <span class="n">server_public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;server-ecdhkey.pem&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">client_key</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">load_pem_private_key</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">server_secret</span> <span class="o">=</span> <span class="n">client_key</span><span class="o">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">ec</span><span class="o">.</span><span class="n">ECDH</span><span class="p">(),</span> <span class="n">server_public_key</span><span class="p">)</span>

<span class="n">derived_key</span> <span class="o">=</span> <span class="n">HKDF</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
                <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">salt</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;SaltyMcSaltFace&#39;</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;mytls&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span>
                    <span class="n">server_ephemeral_secret</span> <span class="o">+</span>
                    <span class="n">server_secret</span> <span class="o">+</span>
                    <span class="nb">bytes</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span>
                    <span class="n">server_random</span>
                <span class="p">)</span>

<span class="n">client_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<span class="n">client_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;client myTLS successful!&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Please provide the client HMAC:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">client_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

<span class="n">server_hmac</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">HMAC</span><span class="p">(</span><span class="n">derived_key</span><span class="p">,</span> <span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">())</span>
<span class="n">server_hmac</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;server myTLS successful!&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Server HMAC:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">server_hmac</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="c1"># now ignore</span>
<span class="nb">print</span><span class="p">(</span><span class="n">print_decrypted</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">server_random</span><span class="p">,</span> <span class="n">derived_key</span><span class="p">))</span>
<span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># b&#39;Hello admin! CTF{KeyC0mpromiseAll0w51mpersonation}\n&#39;</span>
</pre></div>
</div>
</section>
<section id="primes">
<h2>PRIMES<a class="headerlink" href="#primes" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright 2023 Google LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     https://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="k">def</span> <span class="nf">to_bits</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">_bin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">b</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_bin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">m</span><span class="p">],</span> <span class="p">[])</span>

<span class="k">def</span> <span class="nf">gen_primes</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">primes</span> <span class="o">=</span> <span class="n">Primes</span><span class="p">()[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="n">prod</span><span class="p">(</span><span class="n">primes</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">r</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">primes</span><span class="p">,</span> <span class="n">next_prime</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prod_exp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">prod</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))])</span> <span class="o">%</span> <span class="n">q</span>

<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">gen_primes</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">prod_exp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">to_bits</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<span class="n">m</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;I have a sweet flag for you: CTF</span><span class="si">{YkDOLIStjpjP5Am1SXDt5d2r9es3b5KZP47v8rXF}</span><span class="s2">&quot;</span>
<span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="mi">131</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">m</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;q = 0x</span><span class="si">{</span><span class="n">q</span><span class="si">:</span><span class="s1">X</span><span class="si">}</span><span class="se">\n</span><span class="s1">x = 0x</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">X</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># q = 0xD2F8711CB5502C512ACEA59BE181A8FCF12F183B540D9A6998BF66370F9538F7E39FC507545DAD9AA2E71D3313F0B4408695A0A2C03A790662A9BD01650533C584C90779B73604FB8157F0AB7C9A82E724700E5937D9FF5FCF1EE3BE1EDD7E07B4C0F035A58CC2B9DB8B79F176F595C1B0E90B7957309B96106A50A01B78171599B41C8744BCB1C0E6A24F60AE8946D37F4D4BD8CF286A336E1022996B3BA3918E4D808627D0315BFE291AEB884CBE98BB620DAA735B0467F3287D158231D</span>
<span class="c1"># x = 0x947062E712C031ADD0B60416D3B87D54B50C1EFBC8DBB87346F960B242AF3DF6DD47406FEC98053A967D28FE91B130FF0FE93689122931F0BA6E73A3E9E6C873B8E2344A459244D1295E99A241E59E1EEA796E9738E6B1EDEED3D91AE6747E8ECA634C030B90B02BAF8AE0088058F6994C7CAC232835AC72D8B23A96F10EF03D74F82C49D4513423DAC298698094B5C631B9C7C62850C498330E9D112BB9CAA574AEE6B0E5E66D5B234B23C755AC1719B4B68133E680A7BCF48B4CFD0924D</span>
</pre></div>
</div>
<p>Đề bài cho mình một dãy các số nguyên tố <span class="math notranslate nohighlight">\(p_i\)</span> cố định và một số nguyên tố <span class="math notranslate nohighlight">\(q\)</span>.</p>
<p>Giả sử plaintext được biểu diễn ở dạng chuỗi bit <span class="math notranslate nohighlight">\(b = (b_1, b_2, \ldots, b_n)\)</span> thì ciphertext sẽ là <span class="math notranslate nohighlight">\(x = \prod_{i=1}^n p_i^{b_i} \bmod q\)</span>.</p>
<p>Tuy nhiên message <span class="math notranslate nohighlight">\(m\)</span> mà đề cho không encrypt ra <span class="math notranslate nohighlight">\(x\)</span> tương ứng, mình sẽ gọi là <span class="math notranslate nohighlight">\(y\)</span>. Nghĩa là nếu biểu diễn <span class="math notranslate nohighlight">\(m = (m_1, m_2, \ldots, m_n)\)</span> thì mình có <span class="math notranslate nohighlight">\(y = \prod_{i=1}^n p_i^{m_i} \bmod q\)</span>. Ở đây <span class="math notranslate nohighlight">\(m\)</span> và flag có cùng độ dài và sự sai lệch bit không đáng kể.</p>
<p>Hmm, sai lệch bit không đáng kể? :v</p>
<p>Đặt <span class="math notranslate nohighlight">\(e = x y^{-1} = \prod_{i=1}^n p_i^{b_i - m_i} = \prod_{i=1}^n p_i^{e_i} \bmod q\)</span>. Khi đó <span class="math notranslate nohighlight">\(e_i \in \{-1, 0, 1\}\)</span>.</p>
<p>Suy ra <span class="math notranslate nohighlight">\(e = nd^{-1} \bmod q\)</span> với <span class="math notranslate nohighlight">\(n\)</span> và <span class="math notranslate nohighlight">\(d\)</span> phân tích được thành lũy thừa dương của các <span class="math notranslate nohighlight">\(p_i\)</span>, từ đó tồn tại <span class="math notranslate nohighlight">\(s \in \mathbb{Z}\)</span> để <span class="math notranslate nohighlight">\(ed = n + sq\)</span>.</p>
<p>Do <span class="math notranslate nohighlight">\(\lvert ed - sq \rvert = n\)</span> nên tương đương với <span class="math notranslate nohighlight">\(\Bigg\lvert \dfrac{ed}{qd} - \dfrac{sq}{qd} \Bigg\rvert = \dfrac{n}{qd}\)</span>, hay <span class="math notranslate nohighlight">\(\Bigg\lvert \dfrac{e}{q} - \dfrac{s}{d} \Bigg\rvert = \dfrac{n}{qd}\)</span>.</p>
<p>Bài này dựa trên ý tưởng <a class="reference external" href="https://en.wikipedia.org/wiki/Diophantine_approximation">xấp xỉ Diophantine</a>. Ở đây điều kiện để tồn tại chuỗi liên phân số hội tụ là <span class="math notranslate nohighlight">\(nd &lt; \dfrac{q}{2}\)</span>. Khi đó <span class="math notranslate nohighlight">\(\dfrac{s}{d}\)</span> là liên phân số hội tụ dần tới <span class="math notranslate nohighlight">\(\dfrac{1}{d^2}\)</span> do <span class="math notranslate nohighlight">\(\dfrac{n}{qd} &lt; \dfrac{1}{d^2}\)</span>.</p>
<p>Sử dụng SageMath mình có thể tìm được dãy các phân số <span class="math notranslate nohighlight">\(\dfrac{s_j}{d_j}\)</span> hội tụ tới <span class="math notranslate nohighlight">\(\dfrac{1}{d^2}\)</span>. Do đó chiến thuật để giải bài này là tìm <span class="math notranslate nohighlight">\(d_j\)</span> mà có thể phân tích thành lũy thừa không âm của các <span class="math notranslate nohighlight">\(p_i\)</span> (tương ứng <span class="math notranslate nohighlight">\(y\)</span>). Sau đó với <span class="math notranslate nohighlight">\(d_j e\)</span> mà cũng có thể phân tích thành lũy thừa không âm của các <span class="math notranslate nohighlight">\(p_i\)</span> (tương ứng với <span class="math notranslate nohighlight">\(x\)</span>) thì ta sẽ tìm được phân tích tốt nhất để sửa các bit error <span class="math notranslate nohighlight">\(e_i\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_bits</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">_bin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">b</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_bin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">m</span><span class="p">],</span> <span class="p">[])</span>

<span class="k">def</span> <span class="nf">from_bits</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="n">_byte</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span> <span class="p">:</span> <span class="nb">bytes</span><span class="p">([</span><span class="nb">sum</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)])])</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_byte</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="mi">7</span><span class="p">)])</span>

<span class="k">def</span> <span class="nf">gen_primes</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">primes</span> <span class="o">=</span> <span class="n">Primes</span><span class="p">()[:</span><span class="n">n</span><span class="p">]</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="n">prod</span><span class="p">(</span><span class="n">primes</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="n">r</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">primes</span><span class="p">,</span> <span class="n">next_prime</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bitxor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^^</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))]</span>

<span class="k">def</span> <span class="nf">prod_exp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">prod</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))])</span> <span class="o">%</span> <span class="n">q</span>

<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">gen_primes</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">prod_exp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">to_bits</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">cfactor</span><span class="p">(</span><span class="n">primes</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">primes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">//=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>

<span class="n">m</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;I have a sweet flag for you: CTF</span><span class="si">{YkDOLIStjpjP5Am1SXDt5d2r9es3b5KZP47v8rXF}</span><span class="s2">&quot;</span>
<span class="c1">#p, q, x = encode(131, 7*len(m), m)</span>

<span class="n">q</span> <span class="o">=</span> <span class="mh">0xD2F8711CB5502C512ACEA59BE181A8FCF12F183B540D9A6998BF66370F9538F7E39FC507545DAD9AA2E71D3313F0B4408695A0A2C03A790662A9BD01650533C584C90779B73604FB8157F0AB7C9A82E724700E5937D9FF5FCF1EE3BE1EDD7E07B4C0F035A58CC2B9DB8B79F176F595C1B0E90B7957309B96106A50A01B78171599B41C8744BCB1C0E6A24F60AE8946D37F4D4BD8CF286A336E1022996B3BA3918E4D808627D0315BFE291AEB884CBE98BB620DAA735B0467F3287D158231D</span>
<span class="n">X</span> <span class="o">=</span> <span class="mh">0x947062E712C031ADD0B60416D3B87D54B50C1EFBC8DBB87346F960B242AF3DF6DD47406FEC98053A967D28FE91B130FF0FE93689122931F0BA6E73A3E9E6C873B8E2344A459244D1295E99A241E59E1EEA796E9738E6B1EDEED3D91AE6747E8ECA634C030B90B02BAF8AE0088058F6994C7CAC232835AC72D8B23A96F10EF03D74F82C49D4513423DAC298698094B5C631B9C7C62850C498330E9D112BB9CAA574AEE6B0E5E66D5B234B23C755AC1719B4B68133E680A7BCF48B4CFD0924D</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Primes</span><span class="p">()[:</span><span class="mi">7</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">to_bits</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">prod_exp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">%</span> <span class="n">q</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">continued_fraction</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">q</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">convergents</span><span class="p">():</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">denominator</span><span class="p">()</span> <span class="c1"># D</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">E</span> <span class="o">%</span> <span class="n">q</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">cfactor</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">Fp</span> <span class="o">=</span> <span class="n">cfactor</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">F</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Fp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">F</span><span class="o">+</span><span class="n">Fp</span><span class="p">:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">bitxor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">from_bits</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="diceCTF-2023.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Dice CTF 2023</p>
      </div>
    </a>
    <a class="right-next"
       href="2023-18-12-backdoorCTF-2023.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Backdoor CTF 2023</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#least-common-genominator">LEAST COMMON GENOMINATOR?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cursved">Cursved</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mhk2">MHK2</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tao-private-key">1. Tạo private key</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tao-public-key">2. Tạo public key</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ma-hoa">3. Mã hóa</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#khoi-phuc-private-key">4. Khôi phục private key</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-khoi-phuc-modulo">a. Khôi phục modulo</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#b-khoi-phuc-e">b. Khôi phục e</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#c-code-giai">c. Code giải</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mytls">MYTLS</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#primes">PRIMES</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>